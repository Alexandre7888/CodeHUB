<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Spotify RGB OAuth</title>
<style>
body{
  background:#000;
  color:#fff;
  font-family:Arial;
  margin:0;
}
button{
  background:#1db954;
  border:none;
  padding:10px 18px;
  border-radius:20px;
  cursor:pointer;
  font-weight:bold;
}
.song{
  display:flex;
  gap:10px;
  padding:10px;
  background:#111;
  margin:8px;
  border-radius:10px;
  cursor:pointer;
}
.song img{width:50px;border-radius:6px}
</style>
</head>
<body>

<button onclick="login()">Login Spotify</button>
<div id="results"></div>
<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const CLIENT_ID = "66ec7b6fad70470595619345176e3bd3";
const REDIRECT = window.location.origin;
const SCOPES = "user-top-read";
const YT_KEY = "AIzaSyDQ5kbZin0YzoNgpxNkeG45M6PMXCy9pgI";

let player;

// LOGIN
function login(){
  location.href =
    "https://accounts.spotify.com/authorize" +
    "?response_type=token" +
    "&client_id="+CLIENT_ID+
    "&scope="+encodeURIComponent(SCOPES)+
    "&redirect_uri="+encodeURIComponent(REDIRECT);
}

// TOKEN
if(location.hash){
  const p = new URLSearchParams(location.hash.slice(1));
  localStorage.setItem("token", p.get("access_token"));
  localStorage.setItem("exp", Date.now()+p.get("expires_in")*1000);
  location.hash="";
}

const token = localStorage.getItem("token");
const exp = localStorage.getItem("exp");
if(!token || Date.now()>exp){
  console.log("Token invÃ¡lido");
}else{
  buscarTop();
}

// SPOTIFY
async function buscarTop(){
  const r = await fetch(
    "https://api.spotify.com/v1/me/top/tracks?limit=10",
    {headers:{Authorization:"Bearer "+token}}
  );
  const d = await r.json();
  results.innerHTML="";
  d.items.forEach(t=>{
    const s=document.createElement("div");
    s.className="song";
    s.innerHTML=`<img src="${t.album.images[0].url}">
    <div><b>${t.name}</b><br>${t.artists[0].name}</div>`;
    s.onclick=()=>play(t.name+" "+t.artists[0].name);
    results.appendChild(s);
  });
}

// YOUTUBE
async function play(q){
  const y=await fetch(
    `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${encodeURIComponent(q)}&key=${YT_KEY}`
  );
  const id=(await y.json()).items[0].id.videoId;
  player.loadVideoById(id);
}

function onYouTubeIframeAPIReady(){
  player=new YT.Player("player",{height:"0",width:"0"});
}
</script>

</body>
</html>