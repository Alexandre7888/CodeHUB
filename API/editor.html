<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Criador de Aplicativos com Token, Regras e Domínios</title>
<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: 40px auto;
  background: #121212;
  color: #eee;
  padding: 20px;
  border-radius: 8px;
}
input, button, textarea {
  padding: 10px;
  margin: 5px 0;
  width: 100%;
  border-radius: 5px;
  border: none;
  font-size: 16px;
  box-sizing: border-box;
}
input, textarea { background: #222; color: #eee; }
textarea { min-height: 80px; resize: vertical; }
button {
  background: #4caf50;
  color: white;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
  width: auto;
  padding: 8px 16px;
  margin-right: 10px;
}
button:hover { background: #45a049; }
h1,h2 { text-align:center; margin-bottom:20px; color:#4caf50; }
.section { background:#1a1a1a; padding:20px; border-radius:8px; margin-bottom:20px; }
.token-item { background:#222; padding:15px; margin-bottom:15px; border-radius:6px; word-break:break-all; }
.token-item strong { display:block; margin-bottom:4px; color:#81c784; }
</style>
</head>
<body>

<h1>Criador de Aplicativos</h1>

<div class="section">
<h2>Criar Novo Aplicativo</h2>
<form id="appForm">
  <input type="text" id="appName" placeholder="Nome do Aplicativo" required />
  <input type="url" id="redirectURL" placeholder="URL do Redirecionador (ex: dashboard.html)" required />
  <textarea id="rules" placeholder='Regras da API (JSON ou texto, ex: {"rateLimit":100})'></textarea>
  <textarea id="allowedDomains" placeholder="Domínios autorizados, separados por vírgula (ex: example.com, mysite.com)"></textarea>
  <button type="submit">Gerar Token e Salvar</button>
</form>
</div>

<div id="tokenList" class="section">
<h2>APIs Criadas</h2>
<div id="tokensContainer">Carregando...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
  authDomain: "html-15e80.firebaseapp.com",
  databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
  projectId: "html-15e80",
  storageBucket: "html-15e80.appspot.com",
  messagingSenderId: "1068148640439",
  appId: "1:1068148640439:web:7cc5bde34f4c5a5ce41b32"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const appForm = document.getElementById('appForm');
const appNameInput = document.getElementById('appName');
const redirectInput = document.getElementById('redirectURL');
const rulesInput = document.getElementById('rules');
const domainsInput = document.getElementById('allowedDomains');
const tokensContainer = document.getElementById('tokensContainer');

let userUID = null;

// Gera token aleatório
function generateToken(length=20){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let token='';
  for(let i=0;i<length;i++){ token+=chars.charAt(Math.floor(Math.random()*chars.length)); }
  return token;
}

// Criptografa a chave da API
function encryptKey(data){ return btoa(data); } // Base64 simples, opcional AES mais forte

// Verifica login
onAuthStateChanged(auth, user=>{
  if(!user){ alert("Faça login primeiro."); return; }
  userUID = user.uid;
  loadTokens();
});

// Salvar token no Firebase
async function saveToken(token, appName, redirectURL, rules, allowedDomains){
  const apiKey = encryptKey(generateToken(30));
  await set(ref(db, `tokens/${token}`), {
    appName,
    redirectURL,
    rules: rules || {},
    allowedDomains: allowedDomains || [],
    apiKey,
    ownerUID: userUID,
    createdAt: new Date().toISOString()
  });
  alert('Token criado com sucesso!');
  loadTokens();
}

// Carregar tokens do usuário
function loadTokens(){
  const tokensRef = ref(db, 'tokens');
  onValue(tokensRef, snapshot=>{
    const data = snapshot.val();
    tokensContainer.innerHTML='';
    if(!data){ tokensContainer.textContent='Nenhum token criado.'; return; }

    const tokens = Object.entries(data).filter(([token,val])=>val.ownerUID===userUID);
    if(tokens.length===0){ tokensContainer.textContent='Nenhum token criado.'; return; }

    tokens.forEach(([token,val])=>{
      const div=document.createElement('div');
      div.className='token-item';
      div.innerHTML=`
        <strong>App:</strong> ${val.appName}<br/>
        <strong>Token:</strong> ${token}<br/>
        <strong>Redirecionador:</strong> ${val.redirectURL}<br/>
        <strong>Chave Criptografada:</strong> ${val.apiKey}<br/>
        <strong>Regras:</strong> ${JSON.stringify(val.rules)}<br/>
        <strong>Domínios Autorizados:</strong> ${val.allowedDomains.join(', ')}
      `;
      tokensContainer.appendChild(div);
    });
  });
}

// Quando envia o formulário
appForm.addEventListener('submit', e=>{
  e.preventDefault();
  const appName = appNameInput.value.trim();
  const redirectURL = redirectInput.value.trim();
  let rules = {};
  let domains = [];

  try { rules = rulesInput.value? JSON.parse(rulesInput.value) : {}; } catch(e){ alert('Regras inválidas JSON'); return; }
  domains = domainsInput.value ? domainsInput.value.split(',').map(d=>d.trim()).filter(d=>d) : [];

  if(!appName || !redirectURL){ alert('Preencha todos os campos'); return; }

  const token = generateToken();
  saveToken(token, appName, redirectURL, rules, domains);

  appNameInput.value=''; redirectInput.value=''; rulesInput.value=''; domainsInput.value='';
});
</script>
</body>
</html>
