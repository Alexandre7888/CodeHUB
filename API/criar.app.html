<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Criador de Aplicativos com Token - 1GB por Token</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      background: #121212;
      color: #eee;
      padding: 20px;
      border-radius: 8px;
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
    }
    input, textarea {
      background: #222;
      color: #eee;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background: #4caf50;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      width: auto;
      padding: 8px 16px;
      margin-right: 10px;
      margin-top: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button.file-manager-btn {
      background: #9C27B0;
    }
    button.file-manager-btn:hover {
      background: #7B1FA2;
    }
    button.url-btn {
      background: #FF9800;
    }
    button.url-btn:hover {
      background: #F57C00;
    }
    button.api-btn {
      background: #607D8B;
    }
    button.api-btn:hover {
      background: #455A64;
    }
    button.delete-btn {
      background: #f44336;
    }
    button.delete-btn:hover {
      background: #d32f2f;
    }
    button.settings-btn {
      background: #2196F3;
    }
    button.settings-btn:hover {
      background: #1976D2;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #4caf50;
    }
    #tokenList {
      margin-top: 30px;
    }
    .token-item {
      background: #222;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      word-break: break-all;
    }
    .token-item strong {
      display: block;
      margin-bottom: 4px;
      color: #81c784;
    }
    .storage-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .storage-bar {
      height: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 5px;
    }
    .storage-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      transition: width 0.5s ease;
    }
    .storage-text {
      font-size: 14px;
      font-weight: bold;
      color: white;
    }
    .storage-size {
      font-size: 24px;
      font-weight: bold;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .api-url {
      color: #64b5f6;
      text-decoration: none;
      word-break: break-all;
      display: block;
      margin: 10px 0;
      padding: 8px;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #333;
    }
    .api-download-url {
      color: #81c784;
      text-decoration: none;
      word-break: break-all;
      display: block;
      margin: 10px 0;
      padding: 8px;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #4caf50;
    }
    .download-btn {
      background: #9C27B0;
      margin-top: 5px;
    }
    .download-btn:hover {
      background: #7B1FA2;
    }
    .section {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .url-container {
      margin: 10px 0;
    }
    .url-type {
      color: #81c784;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #81c784;
      font-weight: bold;
    }
    .form-group input, .form-group textarea {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 8px;
      border-radius: 4px;
      color: #eee;
    }
    .api-info {
      background: #1a1a1a;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #607D8B;
    }
    .api-info-item {
      margin: 5px 0;
      padding: 5px;
      background: #2a2a2a;
      border-radius: 3px;
    }
    .api-key {
      font-family: monospace;
      background: #333;
      padding: 5px 10px;
      border-radius: 3px;
      margin: 5px 0;
      display: inline-block;
      word-break: break-all;
    }
    .rules-display {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      background: #2a2a2a;
      padding: 10px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      margin: 5px 0;
    }
    .domains-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin: 5px 0;
    }
    .domain-tag {
      background: #2d3748;
      color: #90cdf4;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .btn{
      display:inline-block;
      padding:10px 18px;
      background:#2b6cb0;
      color:#fff;
      text-decoration:none;
      border-radius:8px;
      font-weight:600;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .btn:hover{ opacity:0.95; transform:translateY(-1px); }
    .token-actions {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #333;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .config-form {
      margin-top: 15px;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 5px;
      border: 1px solid #333;
    }
    .config-form h3 {
      margin-top: 0;
      color: #2196F3;
    }
    .no-config {
      color: #ff9800;
      font-style: italic;
      padding: 8px;
      background: #2a2a2a;
      border-radius: 4px;
      border: 1px solid #ff9800;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Criador de Aplicativos - 1GB por Token</h1>
  <a href="https://alexandre7888.github.io/CodeHUB/documentacao.html"
     class="btn"
     target="_blank"
     rel="noopener noreferrer">
    Abrir Documenta√ß√£o
  </a>
  <a href="file-manager.html"
     class="btn"
     style="background: #9C27B0;">
    üìÅ Gerenciador de Arquivos
  </a>

  <div class="section">
    <h2>Criar Novo Aplicativo</h2>
    <form id="appForm">
      <div class="form-group">
        <input type="text" id="appName" placeholder="Nome do Aplicativo" required />
      </div>
      <div class="form-group">
        <input type="url" id="redirectURL" placeholder="URL do Redirecionador (ex: dashboard.html)" required />
      </div>
      <button type="submit">Gerar Token e Salvar (1GB de Armazenamento)</button>
    </form>
  </div>

  <div id="tokenList" class="section">
    <h2>APIs Criadas</h2>
    <div id="tokensContainer">Carregando...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:7cc5bde34f4c5a5ce41b32",
      measurementId: "G-V57KRZ02HJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const appForm = document.getElementById('appForm');
    const appNameInput = document.getElementById('appName');
    const redirectInput = document.getElementById('redirectURL');
    const tokensContainer = document.getElementById('tokensContainer');

    let userUID = null;
    let currentTokens = [];

    // Gera token aleat√≥rio
    function generateToken(length = 20) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for(let i=0; i<length; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    // Gera uma chave de API aleat√≥ria
    function generateApiKey(length = 32) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_-+=';
      let key = '';
      for(let i=0; i<length; i++) {
        key += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return key;
    }

    // Salvar token no localStorage
    function saveTokenToLocalStorage(token, appName, redirectURL) {
      try {
        const existingTokens = JSON.parse(localStorage.getItem('userTokens') || '[]');
        const tokenExists = existingTokens.some(t => t.value === token);
        if (!tokenExists) {
          const newToken = {
            value: token,
            appName: appName,
            redirectURL: redirectURL,
            createdAt: new Date().toISOString()
          };
          existingTokens.push(newToken);
          localStorage.setItem('userTokens', JSON.stringify(existingTokens));
        }
      } catch (error) {
        console.error('Erro ao salvar token no localStorage:', error);
      }
    }

    // Calcular uso de armazenamento
    async function calculateStorageUsage(token) {
      try {
        const filesRef = ref(db, `files/${token}`);
        const snapshot = await get(filesRef);
        const data = snapshot.val();
        
        let totalSize = 0;
        if (data) {
          Object.values(data).forEach(file => {
            if (file.size && typeof file.size === 'number') {
              totalSize += file.size;
            } else if (file.content) {
              // Estimar tamanho do base64
              totalSize += Math.floor(file.content.length * 0.75);
            }
          });
        }
        
        return {
          used: totalSize,
          total: 1073741824, // 1GB em bytes
          percent: (totalSize / 1073741824) * 100
        };
      } catch (error) {
        console.error('Erro ao calcular armazenamento:', error);
        return { used: 0, total: 1073741824, percent: 0 };
      }
    }

    // Formatar bytes para tamanho leg√≠vel
    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Verifica login
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Voc√™ precisa estar logado para criar aplicativos.");
        window.location.href = "https://alexandre7888.github.io/CodeHUB/auth";
        return;
      }
      userUID = user.uid;
      loadTokens();
    });

    // Salvar token b√°sico
    async function saveToken(token, appName, redirectURL) {
      try {
        const tokenData = {
          appName,
          redirectURL,
          ownerUID: userUID,
          createdAt: new Date().toISOString(),
          storageLimit: 1073741824, // 1GB em bytes
          storageUsed: 0
        };

        await set(ref(db, `tokens/${token}`), tokenData);

        saveTokenToLocalStorage(token, appName, redirectURL);
        alert('Token criado com sucesso! (1GB de armazenamento dispon√≠vel)');
        loadTokens();
        return true;
      } catch(e) {
        alert('Erro ao salvar token: ' + e.message);
        return false;
      }
    }

    // Carregar tokens do usu√°rio
    async function loadTokens() {
      const tokensRef = ref(db, 'tokens');
      onValue(tokensRef, async (snapshot) => {
        const data = snapshot.val();
        tokensContainer.innerHTML = '';

        if (!data) {
          tokensContainer.textContent = 'Nenhum token criado ainda.';
          return;
        }

        const tokens = Object.entries(data).filter(([token, val]) => val.ownerUID === userUID);
        currentTokens = tokens;

        if (tokens.length === 0) {
          tokensContainer.textContent = 'Nenhum token criado ainda.';
          return;
        }

        for (const [token, val] of tokens) {
          // Container para cada API
          const div = document.createElement('div');
          div.className = 'token-item';

          // Calcular uso de armazenamento
          const storageInfo = await calculateStorageUsage(token);
          
          // URLs
          const baseURL = "https://code.codehub2025.ct.ws/API/continuar-conta";
          const apiDownloadURL = `https://script.google.com/macros/s/AKfycbzxZ4H1DeRbcZiaT9KiUPRQu2ajayUSabYY-NxLcdda9teZF60v0KwIqAhG-BlOem2EQg/exec?token=${token}`;

          // Verificar se tem configura√ß√µes
          const hasConfig = val.apiKey || val.rules || val.allowedDomains;
          const decryptedApiKey = val.apiKey ? atob(val.apiKey) : null;
          const rulesDisplay = val.rules ? JSON.stringify(val.rules, null, 2) : 'Nenhuma regra definida';
          
          let domainsDisplay = 'Nenhum dom√≠nio restrito';
          if (val.allowedDomains && val.allowedDomains.length > 0) {
            domainsDisplay = val.allowedDomains.map(domain => `<span class="domain-tag">${domain}</span>`).join('');
          }

          div.innerHTML = `
            <strong>Aplicativo:</strong> ${val.appName}<br/>
            <strong>Token:</strong> ${token}<br/>
            <strong>Redirecionador:</strong> ${val.redirectURL}<br/>
            <strong>Criado em:</strong> ${new Date(val.createdAt).toLocaleString()}<br/>
            
            <div class="storage-info">
              <div>
                <div class="storage-text">Armazenamento: ${formatBytes(storageInfo.used)} / ${formatBytes(storageInfo.total)}</div>
                <div class="storage-bar">
                  <div class="storage-fill" style="width: ${Math.min(storageInfo.percent, 100)}%"></div>
                </div>
              </div>
              <div class="storage-size">1 GB</div>
            </div>
                
            <div class="url-container">
              <div class="url-type">URL para Continuar Conta:</div>
              <div class="api-url">${baseURL}?token=${token}</div>
            </div>
            
            <div class="url-container">
              <div class="url-type">URL para API/SDK:</div>
              <div class="api-download-url">${apiDownloadURL}</div>
            </div>
          `;

          if (hasConfig) {
            div.innerHTML += `
              <div class="api-info">
                <div class="api-info-item">
                  <strong>Chave de API:</strong><br>
                  <div class="api-key">${decryptedApiKey || 'N√£o definida'}</div>
                </div>
                <div class="api-info-item">
                  <strong>Regras da API:</strong><br>
                  <div class="rules-display">${rulesDisplay}</div>
                </div>
                <div class="api-info-item">
                  <strong>Dom√≠nios Autorizados:</strong><br>
                  <div class="domains-list">${domainsDisplay}</div>
                </div>
              </div>
            `;
          } else {
            div.innerHTML += `
              <div class="no-config">
                ‚ö†Ô∏è Este aplicativo n√£o tem configura√ß√µes de API definidas.
              </div>
            `;
          }

          // Container para bot√µes
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'token-actions';

          // Bot√µes
          const copyUrlBtn = document.createElement('button');
          copyUrlBtn.className = 'url-btn';
          copyUrlBtn.textContent = 'Copiar URL';
          copyUrlBtn.onclick = () => {
            navigator.clipboard.writeText(`${baseURL}?token=${token}`);
            alert('URL copiada!');
          };

          const fileManagerBtn = document.createElement('button');
          fileManagerBtn.className = 'file-manager-btn';
          fileManagerBtn.textContent = 'üìÅ Gerenciar Arquivos';
          fileManagerBtn.onclick = () => {
            window.location.href = `file-manager.html?token=${token}`;
          };

          const configBtn = document.createElement('button');
          configBtn.className = 'settings-btn';
          configBtn.textContent = hasConfig ? 'Editar Configura√ß√µes' : 'Configurar API';
          configBtn.onclick = () => showConfigForm(token, val, hasConfig);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'Excluir Aplicativo';
          deleteBtn.onclick = () => deleteToken(token, val.appName);

          actionsDiv.appendChild(copyUrlBtn);
          actionsDiv.appendChild(fileManagerBtn);
          actionsDiv.appendChild(configBtn);
          actionsDiv.appendChild(deleteBtn);
          div.appendChild(actionsDiv);

          tokensContainer.appendChild(div);
        }
      });
    }

    // Quando enviar o formul√°rio
    appForm.addEventListener('submit', e => {
      e.preventDefault();
      const appName = appNameInput.value.trim();
      const redirectURL = redirectInput.value.trim();

      if (!appName || !redirectURL) {
        alert('Preencha todos os campos!');
        return;
      }

      const token = generateToken();
      saveToken(token, appName, redirectURL);

      appNameInput.value = '';
      redirectInput.value = '';
    });
  </script>
</body>
</html>
