<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ğŸ¤– Painel de Bots - Segundo Plano 24/7</title>
<style>
* { box-sizing: border-box; }
body { 
  font-family: 'Segoe UI', Arial, sans-serif; 
  background: #0a0c10; 
  color: #e6e9f0; 
  margin: 0; 
  padding: 0;
}

header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  background: #1a1e24;
  padding: 15px 30px; 
  border-bottom: 2px solid #2d9cdb;
}

header h1 { margin: 0; font-size: 24px; }

.status-badge {
  background: #1e2a36;
  padding: 6px 14px;
  border-radius: 30px;
  font-size: 13px;
}

nav { 
  display: flex; 
  background: #14181c; 
  padding: 0 20px;
}

nav a { 
  padding: 14px 20px; 
  text-decoration: none; 
  color: #b0b9c4; 
  border-right: 1px solid #252c32; 
  transition: all 0.2s;
}

nav a:hover { background: #1e262c; }
nav a.active { background: #1e2a36; color: #2d9cdb; border-bottom: 3px solid #2d9cdb; }

section { display: none; padding: 30px; }
section.active { display: block; }

.panel {
  background: #151a1f;
  border-radius: 16px;
  padding: 25px;
  margin-bottom: 30px;
  border: 1px solid #2a323a;
}

.panel h3 { 
  margin-top: 0; 
  color: #a0d6ff; 
  border-bottom: 1px solid #2d3a44; 
  padding-bottom: 12px; 
}

button, input, textarea, select {
  margin: 8px 0; 
  padding: 12px 16px; 
  width: 100%; 
  border-radius: 12px; 
  border: none; 
  font-size: 15px;
  background: #1e262c;
  color: #fff;
  border: 1px solid #36424a;
}

button {
  background: #2d9cdb;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: opacity 0.2s;
}

button:hover { opacity: 0.9; }

.bot, .codeItem {
  padding: 14px 18px; 
  border: 1px solid #2a323a; 
  margin: 8px 0; 
  cursor: pointer; 
  border-radius: 12px;
  background: #1a1f24;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: background 0.2s;
}

.bot:hover, .codeItem:hover { background: #242c34; }

.bot-avatar { 
  width: 45px; 
  height: 45px; 
  border-radius: 50%; 
  object-fit: cover; 
  border: 2px solid #2d9cdb; 
}

.messages { 
  max-height: 280px; 
  overflow-y: auto; 
  background: #0e1217; 
  padding: 18px; 
  border-radius: 16px; 
  border: 1px solid #2a323a;
}

.msg { 
  padding: 10px 16px; 
  background: #1e262e; 
  border-radius: 20px; 
  margin: 4px 0;
  word-break: break-word;
}

.msg.own { 
  background: #1f4a5c; 
}

.msg-time {
  float: right;
  color: #888;
  font-size: 11px;
  margin-left: 10px;
}

.msg-readby {
  font-size: 10px;
  color: #2d9cdb;
  margin-top: 4px;
}

img { 
  border-radius: 50%; 
  max-width: 50px; 
  vertical-align: middle; 
  margin-right: 5px; 
}

.copyBtn { 
  cursor: pointer; 
  color: #2d9cdb; 
  margin-left: 5px; 
  padding: 2px 6px;
  background: #1e2a36;
  border-radius: 6px;
}

.asset-item, .group-item {
  padding: 12px 16px;
  background: #1a1f24;
  border: 1px solid #2a323a;
  border-radius: 12px;
  margin: 8px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.group-item { cursor: pointer; }
.group-item:hover { background: #242c34; }

.delete-btn {
  color: #ff6b6b;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
}

.delete-btn:hover { background: #3a1e1e; }

.background-status {
  margin-top: 10px;
  padding: 15px;
  background: #1a1f24;
  border-radius: 8px;
  border-left: 4px solid #27ae60;
}

.bg-active {
  border-left-color: #27ae60;
}

.bg-inactive {
  border-left-color: #e67e22;
}
</style>
</head>
<body>

<header>
  <h1>ğŸ¤– Painel de Bots - 24/7</h1>
  <div>
    <span class="status-badge" id="usernameDisplay">UsuÃ¡rio: --</span>
    <a href="#" onclick="registrarServiceWorker()" style="background:#1e2a36; color:#2d9cdb; padding:6px 14px; border-radius:30px; text-decoration:none; margin-left:10px;">ğŸ“± Ativar SW</a>
  </div>
</header>

<nav>
  <a href="#dashboard" id="navDashboard" class="active">ğŸ“Š Dashboard</a>
  <a href="#editor" id="navEditor">ğŸ“ Editor de Comandos</a>
  <a href="#assets" id="navAssets">ğŸ¨ Assets</a>
</nav>

<!-- DASHBOARD -->
<section id="dashboard" class="active">
  <h2>ğŸ“Š Meus Bots</h2>
  
  <div class="panel">
    <h3>â• Criar Bot</h3>
    <input id="botName" placeholder="Nome do bot">
    <input type="file" id="botAvatar" accept="image/*">
    <button onclick="createBot()">Criar Bot</button>
  </div>

  <div class="panel">
    <h3>ğŸ“‹ Lista de Bots</h3>
    <div id="botList"></div>
  </div>

  <div class="panel" id="botPanel" style="display:none">
    <h3>ğŸ¤– Bot Selecionado</h3>
    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
      <img id="botImg" style="width:80px; height:80px; border-radius:50%; border:3px solid #2d9cdb;">
      <div style="flex:1">
        <input id="editName" placeholder="Nome do bot">
        <button onclick="saveBot()">Salvar</button>
      </div>
    </div>
    
    <p>ğŸ†” ID: <span id="botID"></span> <span class="copyBtn" onclick="copyBotID()">[Copiar]</span></p>
    <p>ğŸ‘‘ Role: <span id="botRoleDisplay">--</span></p>
    <p>ğŸ“¨ Msgs Enviadas: <span id="messageCount">0</span></p>

    <h4>â• Entrar em Grupo</h4>
    <input id="groupId" placeholder="ID do grupo">
    <button onclick="joinGroup()">Entrar no Grupo</button>

    <h4>ğŸ‘¥ Grupos do Bot</h4>
    <div id="groupList"></div>

    <h4 style="color: #2d9cdb; margin-top: 20px;">ğŸ”„ MODO SEGUNDO PLANO (24/7)</h4>
    <div style="display: flex; gap: 10px;">
      <button onclick="ativarBotBackground()" style="background: #27ae60; flex: 2;">
        âœ… ATIVAR 24/7
      </button>
      <button onclick="desativarBotBackground()" style="background: #e67e22; flex: 1;">
        âŒ DESATIVAR
      </button>
    </div>
    <button onclick="executarBotAgora()" style="background: #3498db; margin-top: 5px;">
      âš¡ EXECUTAR AGORA
    </button>

    <div id="backgroundStatus" class="background-status bg-inactive">
      <span>â³ Status: <span id="bgStatusText">Inativo</span></span><br>
      <span style="font-size: 12px; color: #888;">O bot responde mesmo com o navegador fechado</span>
    </div>

    <h4 style="margin-top: 20px;">ğŸ’¬ Mensagens</h4>
    <div class="messages" id="messages"></div>
    <input id="msgText" placeholder="Digite sua mensagem...">
    <button onclick="sendMsg()">ğŸ“¤ Enviar (formato novo)</button>
    <button onclick="deleteAllMessages()" id="deleteBtn" style="background:#c0392b;">ğŸ—‘ï¸ Apagar Todas (sÃ³ admin)</button>
  </div>
</section>

<!-- EDITOR -->
<section id="editor">
  <h2>ğŸ“ Editor de Comandos</h2>
  <div class="panel">
    <input id="codeName" placeholder="Nome do comando (ex: !oi)">
    <textarea id="codeText" rows="8" placeholder="// Exemplo: 
if(msg.text === '!oi') {
  reply('OlÃ¡, ' + msg.senderName + '!');
}"></textarea>
    <button onclick="addCommand()">Adicionar/Salvar Comando</button>
    <div id="codeList"></div>
  </div>
</section>

<!-- ASSETS -->
<section id="assets">
  <h2>ğŸ¨ Assets</h2>
  <div class="panel">
    <p>VocÃª pode enviar Ã¡udios, PDFs ou agendar mensagens aqui.</p>
    <input type="file" id="assetFile">
    <button onclick="addAsset()">Adicionar Asset</button>
    <div id="assetList"></div>
  </div>
</section>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
// ============================================
// CONFIG FIREBASE
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBzRLpZJDMeFASIjje4SJBfTInIEO-GKVI",
  databaseURL: "https://html-785e3-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ============================================
// DADOS GLOBAIS
// ============================================
let bots = JSON.parse(localStorage.getItem("bots")||"[]");
let bot = null;
let currentGroup = null;
let commands = JSON.parse(localStorage.getItem("commands")||"[]");
let assets = JSON.parse(localStorage.getItem("assets")||"[]");

// Mostra nome do usuÃ¡rio
const userData = JSON.parse(localStorage.getItem("chat_user"));
if(userData && userData.name){
    document.getElementById("usernameDisplay").textContent = "UsuÃ¡rio: " + userData.name;
} else {
    document.getElementById("usernameDisplay").textContent = "UsuÃ¡rio: Visitante";
}

// ============================================
// FUNÃ‡ÃƒO UTILITÃRIA - FORMATAR HORA
// ============================================
function formatarHora(timestamp) {
  const date = new Date(timestamp);
  const horas = date.getHours().toString().padStart(2, '0');
  const minutos = date.getMinutes().toString().padStart(2, '0');
  return `${horas}:${minutos}`;
}

// ============================================
// NAVEGAÃ‡ÃƒO
// ============================================
function showSection(hash){
    document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
    document.querySelector(hash).classList.add("active");
    document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
    document.querySelector('nav a[href="'+hash+'"]').classList.add("active");
}
window.addEventListener("hashchange",()=>showSection(location.hash));
if(location.hash) showSection(location.hash);

// ============================================
// FUNÃ‡Ã•ES BOTS
// ============================================
function saveStorage(){localStorage.setItem("bots",JSON.stringify(bots));}

function createBot(){
  const id = "bot_" + Date.now() + "_" + Math.random().toString(36).substr(2, 4);
  const name = document.getElementById("botName").value || id;
  const file = document.getElementById("botAvatar").files[0];
  if(!file){ alert("Escolha avatar"); return; }
  const reader=new FileReader();
  reader.onload=()=>{
    const botData={id, name, avatar:reader.result, status:"offline"};
    bots.push(botData);
    saveStorage();
    db.ref("users/"+id).set({id, name, avatar:reader.result, status:{state:"offline",lastChanged:Date.now()}});
    db.ref("bots/"+id+"/messageCount").set(0);
    loadBots();
    document.getElementById("botName").value = "";
    document.getElementById("botAvatar").value = "";
  };
  reader.readAsDataURL(file);
}

function loadBots(){
  const botListEl = document.getElementById("botList");
  botListEl.innerHTML = "";
  
  bots.forEach(b=>{
    const d = document.createElement("div");
    d.className = "bot";
    
    const img = document.createElement("img");
    img.src = b.avatar;
    img.className = "bot-avatar";
    
    const span = document.createElement("span");
    span.textContent = b.name;
    
    d.appendChild(img);
    d.appendChild(span);
    d.onclick = () => selectBot(b);
    botListEl.appendChild(d);
  });
}
loadBots();

function selectBot(b){
  bot = b;
  document.getElementById("botPanel").style.display = "block";
  document.getElementById("botImg").src = b.avatar;
  document.getElementById("editName").value = b.name;
  document.getElementById("botID").textContent = b.id;
  
  db.ref("bots/" + b.id + "/messageCount").once("value", (snap) => {
    document.getElementById("messageCount").textContent = snap.val() || 0;
  });
  
  loadGroups();
  verificarStatusBackground();
}

function saveBot(){
  bot.name = document.getElementById("editName").value;
  saveStorage();
  db.ref("users/"+bot.id+"/name").set(bot.name);
  db.ref("bots/"+bot.id+"/name").set(bot.name);
  loadBots();
}

function copyBotID(){
  navigator.clipboard.writeText(bot.id).then(()=>alert("ID copiado!"));
}

function joinGroup(){
  currentGroup = document.getElementById("groupId").value;
  if(!currentGroup) return alert("Digite ID do grupo");
  
  db.ref(`groups/${currentGroup}/members/${bot.id}`).once("value", snap=>{
    if(!snap.exists()){
      db.ref(`groups/${currentGroup}/members/${bot.id}`).set({
        id:bot.id, name:bot.name, role:"member", joinedAt:Date.now()
      });
    }
    db.ref("bots/" + bot.id + "/groups/" + currentGroup).set(Date.now());
    checkRole();
    listenMessages();
    loadGroups();
  });
}

function loadGroups(){
  const groupListEl = document.getElementById("groupList");
  groupListEl.innerHTML = "";
  
  db.ref("bots/" + bot.id + "/groups").once("value", (snap) => {
    const groups = snap.val() || {};
    for(let id in groups) {
      const div = document.createElement("div");
      div.className = "group-item";
      div.textContent = "ğŸ‘¥ " + id;
      div.onclick = () => { 
        currentGroup = id; 
        checkRole(); 
        listenMessages(); 
      };
      groupListEl.appendChild(div);
    }
  });
}

function checkRole(){
  if(!bot || !currentGroup) return;
  db.ref(`groups/${currentGroup}/members/${bot.id}`).once("value", snap=>{
    const data = snap.val();
    if(data){
      document.getElementById("botRoleDisplay").textContent = data.role;
      document.getElementById("deleteBtn").disabled = data.role !== "admin";
    }
  });
}

// ============================================
// FUNÃ‡ÃƒO ENVIAR MENSAGEM - FORMATO NOVO
// ============================================
function sendMsg(){
  const text = document.getElementById("msgText").value;
  if(!currentGroup) return alert("Selecione grupo");
  if(!text) return alert("Digite uma mensagem");
  if(!bot) return alert("Selecione um bot");
  
  const timestamp = Date.now();
  const horaFormatada = formatarHora(timestamp);
  
  const mensagem = {
    senderId: bot.id,
    senderName: bot.name,
    text: text,
    timestamp: timestamp,
    time: horaFormatada,
    type: "text",
    readBy: {
      [bot.id]: timestamp
    }
  };
  
  db.ref(`groups/${currentGroup}/messages`).push(mensagem);
  
  db.ref("bots/" + bot.id + "/messageCount").transaction(v => (v||0)+1);
  document.getElementById("messageCount").textContent = parseInt(document.getElementById("messageCount").textContent) + 1;
  
  document.getElementById("msgText").value = "";
}

// ============================================
// OUVIR MENSAGENS
// ============================================
function listenMessages(){
  const messagesEl = document.getElementById("messages");
  messagesEl.innerHTML = "";
  if(!currentGroup) return;
  
  db.ref(`groups/${currentGroup}/messages`).off();
  db.ref(`groups/${currentGroup}/messages`).on("child_added", s=>{
    const msg = s.val();
    
    const div = document.createElement("div");
    div.className = "msg" + (msg.senderId === bot?.id ? " own" : "");
    
    const timeSpan = document.createElement("span");
    timeSpan.className = "msg-time";
    timeSpan.textContent = msg.time || formatarHora(msg.timestamp);
    
    const contentSpan = document.createElement("span");
    contentSpan.textContent = msg.senderName + ": " + (msg.text || "[imagem]");
    
    const readBySpan = document.createElement("div");
    readBySpan.className = "msg-readby";
    if(msg.readBy) {
      const leitores = Object.keys(msg.readBy).length;
      readBySpan.textContent = `ğŸ‘ï¸ ${leitores} leitura(s)`;
    }
    
    div.appendChild(timeSpan);
    div.appendChild(contentSpan);
    div.appendChild(readBySpan);
    messagesEl.appendChild(div);
    
    runBotCommands(msg);
  });
}

// ============================================
// EXECUTAR COMANDOS
// ============================================
function runBotCommands(msg){
  if(!msg?.text || msg.senderId === bot?.id) return;
  
  commands.forEach(cmd => {
    try {
      const reply = (texto) => {
        if(currentGroup) {
          const timestamp = Date.now();
          const horaFormatada = formatarHora(timestamp);
          
          const mensagem = {
            senderId: bot.id,
            senderName: bot.name,
            text: texto,
            timestamp: timestamp,
            time: horaFormatada,
            type: "text",
            readBy: {
              [bot.id]: timestamp
            }
          };
          
          db.ref(`groups/${currentGroup}/messages`).push(mensagem);
          db.ref("bots/" + bot.id + "/messageCount").transaction(v => (v || 0) + 1);
        }
      };
      
      eval(cmd.code);
    } catch(e) {
      console.error('Erro no comando:', e);
    }
  });
}

function deleteAllMessages(){
  if(!currentGroup) return;
  db.ref(`groups/${currentGroup}/members/${bot.id}`).once("value", snap=>{
    const role = snap.val()?.role;
    if(role==="admin"){
      db.ref(`groups/${currentGroup}/messages`).remove().then(()=>alert("Mensagens apagadas!"));
    } else {
      alert("Apenas admins podem apagar mensagens!");
    }
  });
}

// ============================================
// FUNÃ‡Ã•ES COMANDOS
// ============================================
function saveCommands(){localStorage.setItem("commands",JSON.stringify(commands));}

function addCommand(){
  const name = document.getElementById("codeName").value;
  const text = document.getElementById("codeText").value;
  if(!name || !text) return alert("Preencha nome e cÃ³digo");
  const existing = commands.find(c=>c.name===name);
  if(existing){ existing.code = text; } 
  else { commands.push({name, code:text}); }
  saveCommands(); 
  loadCommands();
  document.getElementById("codeName").value = "";
  document.getElementById("codeText").value = "";
}

function loadCommands(){
  const list = document.getElementById("codeList");
  list.innerHTML = "";
  commands.forEach(c=>{
    const div = document.createElement("div");
    div.className = "codeItem";
    div.textContent = c.name;
    div.onclick = ()=>{
      document.getElementById("codeName").value = c.name; 
      document.getElementById("codeText").value = c.code;
    }
    const del = document.createElement("span");
    del.textContent = " [Excluir]";
    del.style.color = "#ff6b6b"; 
    del.style.cursor = "pointer";
    del.onclick = (e)=>{ 
      e.stopPropagation(); 
      commands = commands.filter(x=>x!==c); 
      saveCommands(); 
      loadCommands(); 
    }
    div.appendChild(del);
    list.appendChild(div);
  });
}
loadCommands();

// ============================================
// FUNÃ‡Ã•ES ASSETS
// ============================================
function saveAssets(){localStorage.setItem("assets",JSON.stringify(assets));}

function addAsset(){
  const file = document.getElementById("assetFile").files[0];
  if(!file) return alert("Escolha arquivo");
  const reader = new FileReader();
  reader.onload = ()=>{
    const asset = {name: file.name, data: reader.result, type: file.type, added: Date.now()};
    assets.push(asset); 
    saveAssets(); 
    loadAssets();
  };
  reader.readAsDataURL(file);
}

function loadAssets(){
  const list = document.getElementById("assetList");
  list.innerHTML = "";
  assets.forEach((a, index)=>{
    const div = document.createElement("div");
    div.className = "asset-item";
    
    const nameSpan = document.createElement("span");
    nameSpan.textContent = "ğŸ“ " + a.name;
    
    const del = document.createElement("span");
    del.textContent = "ğŸ—‘ï¸";
    del.className = "delete-btn";
    del.onclick = (e) => {
      e.stopPropagation();
      assets.splice(index, 1);
      saveAssets();
      loadAssets();
    };
    
    div.appendChild(nameSpan);
    div.appendChild(del);
    list.appendChild(div);
  });
}
loadAssets();

// ============================================
// SERVICE WORKER - SEGUNDO PLANO 24/7
// ============================================

async function registrarServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('sw.js', {
        scope: './'
      });
      
      console.log('âœ… Service Worker registrado!');
      await navigator.serviceWorker.ready;
      
      if (Notification.permission === 'default') {
        await Notification.requestPermission();
      }
      
      alert('âœ… Service Worker ativado! Bot pode rodar 24/7');
      return registration;
    } catch (error) {
      console.error('âŒ Erro ao registrar:', error);
      alert('âŒ Erro ao ativar modo segundo plano');
    }
  } else {
    alert('âŒ Service Worker nÃ£o suportado neste navegador');
  }
}

async function ativarBotBackground() {
  if (!bot) return alert('Selecione um bot primeiro');
  if (!currentGroup) return alert('Selecione um grupo');
  
  await registrarServiceWorker();
  
  const registration = await navigator.serviceWorker.ready;
  
  registration.active.postMessage({
    type: 'ATIVAR_BOT',
    botId: bot.id,
    botNome: bot.name,
    botAvatar: bot.avatar,
    grupoId: currentGroup,
    comandos: commands
  });
  
  if (Notification.permission === 'granted') {
    new Notification('ğŸ¤– Bot ativado!', {
      body: `${bot.name} estÃ¡ rodando 24/7 em segundo plano`,
      icon: bot.avatar
    });
  }
  
  document.getElementById('backgroundStatus').className = 'background-status bg-active';
  document.getElementById('bgStatusText').innerHTML = `âœ… ATIVO - ${bot.name}`;
  
  alert(`âœ… Bot ${bot.name} ativado em segundo plano!\nEle vai responder mesmo com o navegador fechado.`);
}

async function desativarBotBackground() {
  if (!bot) return;
  
  if (!('serviceWorker' in navigator)) return;
  
  const registration = await navigator.serviceWorker.ready;
  
  registration.active.postMessage({
    type: 'DESATIVAR_BOT',
    botId: bot.id
  });
  
  document.getElementById('backgroundStatus').className = 'background-status bg-inactive';
  document.getElementById('bgStatusText').innerHTML = 'â­• Inativo';
  
  alert(`âŒ Bot ${bot.name} desativado`);
}

async function executarBotAgora() {
  if (!bot || !currentGroup) return;
  
  await registrarServiceWorker();
  
  const registration = await navigator.serviceWorker.ready;
  
  registration.active.postMessage({
    type: 'EXECUTAR_AGORA',
    botId: bot.id,
    botNome: bot.name,
    grupoId: currentGroup,
    comandos: commands
  });
  
  alert('âš¡ Executando bot agora!');
}

async function verificarStatusBackground() {
  if (!bot) return;
  if (!('serviceWorker' in navigator)) return;
  
  try {
    const registration = await navigator.serviceWorker.getRegistration();
    if (registration && registration.active) {
      const channel = new MessageChannel();
      
      channel.port1.onmessage = (e) => {
        const botsAtivos = e.data || {};
        if (botsAtivos[bot.id]) {
          document.getElementById('backgroundStatus').className = 'background-status bg-active';
          document.getElementById('bgStatusText').innerHTML = `âœ… ATIVO - ${bot.name}`;
        } else {
          document.getElementById('backgroundStatus').className = 'background-status bg-inactive';
          document.getElementById('bgStatusText').innerHTML = 'â­• Inativo';
        }
      };
      
      registration.active.postMessage({
        type: 'GET_STATUS'
      }, [channel.port2]);
    }
  } catch (e) {
    console.error(e);
  }
}

// Registrar SW ao carregar
window.addEventListener('load', () => {
  registrarServiceWorker();
  setInterval(verificarStatusBackground, 3000);
});

// Exportar funÃ§Ãµes
window.registrarServiceWorker = registrarServiceWorker;
window.ativarBotBackground = ativarBotBackground;
window.desativarBotBackground = desativarBotBackground;
window.executarBotAgora = executarBotAgora;
</script>
</body>
</html>