<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Projeto</title>
  <style>
    /* Estilos principais */
    body, html {
      margin: 0; padding: 0; height: 100%;
      display: flex; flex-direction: column;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: white;
    }

    /* Tela de carregamento */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, #1e293b, #0f172a);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      font-family: Arial, sans-serif;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    #loading-screen h1 {
      margin-top: 20px;
      font-size: 1.8em;
      color: #ff9500;
      text-shadow: 0 0 10px #ff9500, 0 0 20px #ff7300;
      animation: glowText 2s infinite alternate;
    }

    .loader {
      width: 280px;
      height: 280px;
      animation: spinScale 4s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255,149,0,0.5);
      transition: all 0.5s ease-in-out;
    }

    @keyframes glowText {
      0% { text-shadow: 0 0 5px #ff9500, 0 0 15px #ff7300; }
      100% { text-shadow: 0 0 15px #ff9500, 0 0 30px #ff7300; }
    }

    @keyframes spinScale {
      0%   { transform: rotate(0deg) scale(1); }
      25%  { transform: rotate(90deg) scale(1.1); }
      50%  { transform: rotate(180deg) scale(0.9); }
      75%  { transform: rotate(270deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 20px rgba(255,149,0,0.5), 0 0 40px rgba(255,149,0,0.3); }
      100% { box-shadow: 0 0 40px rgba(255,149,0,0.8), 0 0 80px rgba(255,149,0,0.5); }
    }

    #app-content {
      display: none;
    }

    /* Barra superior */
    #top-bar {
      display: flex;
      padding: 10px;
      background: #1e1e1e;
      color: white;
      align-items: center;
      border-bottom: 1px solid #333;
      flex-wrap: wrap;
      gap: 10px;
    }

    #project-name {
      font-size: 1.1em;
      font-weight: bold;
      background: transparent;
      color: white;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 5px;
      margin-right: 10px;
      flex: 1;
      max-width: 300px;
    }

    #project-name:hover { border-color: #555; }
    #project-name:focus { outline: 1px solid #4895ef; }

    #newFileForm {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    #newFileForm input {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #252526;
      color: white;
      outline: none;
      width: 150px;
    }

    button {
      background: #4361ee;
      border: none;
      color: white;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    button:hover {
      filter: brightness(1.2);
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
      color: #999;
    }

    #saveFileBtn { background: #4cc9f0; }
    #previewBtn { background: #4895ef; }
    #aiBtn { background: #7209b7; }
    #uploadBtn { background: #3a0ca3; }
    #insertFileBtn { background: #f72585; }

    /* Abas */
    #tabs {
      display: flex;
      background: #252526;
      align-items: center;
      gap: 1px;
      overflow-x: auto;
    }

    #tabs button.tab-btn {
      background: #2d2d2d;
      border: none;
      color: #d4d4d4;
      padding: 8px 15px;
      cursor: pointer;
      position: relative;
      user-select: none;
      white-space: nowrap;
      border-right: 1px solid #1e1e1e;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #tabs button.tab-btn.active {
      background: #1e1e1e;
      color: white;
    }

    #tabs button.tab-btn .close-tab-btn {
      background: transparent;
      border: none;
      color: #bbb;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      line-height: 1;
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    #tabs button.tab-btn .close-tab-btn:hover {
      background: #555;
      color: white;
    }

    /* Container principal */
    #container {
      flex: 1;
      overflow: hidden;
      height: calc(100vh - 100px);
      position: relative;
    }

    /* Bot√£o voltar */
    .back-btn {
      background: #6c757d;
      text-decoration: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Informa√ß√µes do usu√°rio */
    #user-info {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #user-name {
      font-size: 0.9em;
      color: #ccc;
    }

    /* Iframes */
    #ai-iframe-container, #upload-iframe-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1e1e1e;
      z-index: 100;
      display: none;
      flex-direction: column;
    }

    #ai-iframe-header, #upload-iframe-header {
      padding: 10px;
      background: #252526;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #ai-iframe, #upload-iframe {
      flex: 1;
      border: none;
      background: white;
    }

    #close-ai-btn, #close-upload-btn {
      background: #f72585;
      padding: 5px 10px;
      border-radius: 4px;
    }

    /* Notifica√ß√£o de c√≥digo */
    #code-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #252526;
      border: 1px solid #4361ee;
      border-radius: 8px;
      padding: 15px;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
    }

    #code-notification h3 {
      margin-top: 0;
      color: #4cc9f0;
    }

    #code-notification pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 200px;
    }

    #code-notification-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #code-notification-buttons button {
      flex: 1;
    }

    #insert-code-btn {
      background: #4cc9f0;
    }

    #discard-code-btn {
      background: #f72585;
    }

    /* Container de arquivo */
    #file-container {
      width: 100%;
      height: 100%;
      display: none;
      background: #1e1e1e;
    }

    #file-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Status de upload */
    .upload-status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      background: #252526;
      color: white;
      display: none;
    }

    .upload-success {
      background: #4caf50;
    }

    .upload-error {
      background: #f44336;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }

    .modal {
      background: #252526;
      border-radius: 8px;
      padding: 20px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .modal h3 {
      margin-top: 0;
      color: #4cc9f0;
    }

    .modal-select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #333;
      background: #1e1e1e;
      color: white;
      box-sizing: border-box;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-buttons button {
      padding: 8px 16px;
    }

    /* Status de inser√ß√£o */
    #insert-status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }

    .status-success {
      background: #4caf50;
      color: white;
    }

    .status-error {
      background: #f44336;
      color: white;
    }

    /* Editor Monaco */
    .monaco-editor {
      width: 100%;
      height: 100%;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
<script src="protecao.js"></script>
</head>
<body>
  <!-- Tela de carregamento -->
  <div id="loading-screen">
    <img id="codefox" src="https://alexandre7888.github.io/CodeHUB/CodeFOX/foto1.jpg" class="loader" alt="CodeFOX girando">
    <h1>Carregando...</h1>
  </div>

  <!-- Conte√∫do principal (inicialmente oculto) -->
  <div id="app-content">
    <div id="top-bar">
      <a href="index.html" class="back-btn">‚Üê Voltar</a>
      <input type="text" id="project-name" value="Carregando...">
      <form id="newFileForm">
        <input type="text" id="newFileName" placeholder="ex: script.js" required>
        <button type="submit">Criar arquivo</button>
      </form>
      <button id="uploadBtn">üì§ Upload</button>
      <button id="insertFileBtn">üìé Inserir Arquivo</button>
      <button id="saveFileBtn" disabled>üíæ Salvar</button>
      <button id="previewBtn">üëÅÔ∏è Visualizar</button>
      <button id="aiBtn">ü§ñ IA Assistente</button>
      <div id="user-info">
        <span id="user-name">Carregando...</span>
      </div>
    </div>

    <div id="tabs"></div>

    <div id="container">
      <div id="file-container">
        <iframe id="file-iframe" src="about:blank"></iframe>
      </div>
      
      <div id="upload-iframe-container">
        <div id="upload-iframe-header">
          <h3>Upload de Arquivos</h3>
          <button id="close-upload-btn">Fechar</button>
        </div>
        <iframe id="upload-iframe" src="about:blank"></iframe>
      </div>
      
      <div id="ai-iframe-container">
        <div id="ai-iframe-header">
          <h3>Assistente de IA</h3>
          <button id="close-ai-btn">Fechar</button>
        </div>
        <iframe id="ai-iframe" src="about:blank"></iframe>
      </div>
    </div>

    <div id="code-notification">
      <h3>Novo c√≥digo recebido da IA!</h3>
      <p>Selecione em qual arquivo deseja inserir:</p>
      <select id="target-file-select">
        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
      </select>
      <pre id="code-preview"></pre>
      <div id="code-notification-buttons">
        <button id="insert-code-btn">Inserir</button>
        <button id="discard-code-btn">Descartar</button>
      </div>
    </div>

    <!-- Modal para inserir arquivo -->
    <div class="modal-backdrop" id="insertModal">
      <div class="modal">
        <h3>Inserir Arquivo</h3>
        <select id="file-select" class="modal-select">
          <option value="">Selecione um arquivo</option>
        </select>
        <div id="insert-status"></div>
        <div class="modal-buttons">
          <button id="cancel-insert-btn">Cancelar</button>
          <button id="confirm-insert-btn">Inserir Iframe</button>
        </div>
      </div>
    </div>

    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:1ac651348e624f6be41b32",
      measurementId: "G-7E1VWN07GM"
    };

    // Inicializa√ß√£o do Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Vari√°veis globais
    let editor;
    let currentProjectId;
    let currentFile = null;
    let projectRef = null;
    let files = {};
    let models = {};
    let currentUser = null;
    let sessionRef = null;
    let currentCode = null;
    let loaderInterval = null;
    let uploadedFiles = {};

    // Elementos da UI
    const elements = {
      newFileNameInput: document.getElementById('newFileName'),
      newFileForm: document.getElementById('newFileForm'),
      saveFileBtn: document.getElementById('saveFileBtn'),
      previewBtn: document.getElementById('previewBtn'),
      aiBtn: document.getElementById('aiBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      insertFileBtn: document.getElementById('insertFileBtn'),
      projectNameInput: document.getElementById('project-name'),
      tabsContainer: document.getElementById('tabs'),
      userNameElement: document.getElementById('user-name'),
      aiIframeContainer: document.getElementById('ai-iframe-container'),
      aiIframe: document.getElementById('ai-iframe'),
      closeAiBtn: document.getElementById('close-ai-btn'),
      uploadIframeContainer: document.getElementById('upload-iframe-container'),
      uploadIframe: document.getElementById('upload-iframe'),
      closeUploadBtn: document.getElementById('close-upload-btn'),
      codeNotification: document.getElementById('code-notification'),
      codePreview: document.getElementById('code-preview'),
      targetFileSelect: document.getElementById('target-file-select'),
      insertCodeBtn: document.getElementById('insert-code-btn'),
      discardCodeBtn: document.getElementById('discard-code-btn'),
      loadingScreen: document.getElementById('loading-screen'),
      appContent: document.getElementById('app-content'),
      codefoxImage: document.getElementById('codefox'),
      uploadStatus: document.getElementById('uploadStatus'),
      fileContainer: document.getElementById('file-container'),
      fileIframe: document.getElementById('file-iframe'),
      insertModal: document.getElementById('insertModal'),
      fileSelect: document.getElementById('file-select'),
      insertStatus: document.getElementById('insert-status'),
      cancelInsertBtn: document.getElementById('cancel-insert-btn'),
      confirmInsertBtn: document.getElementById('confirm-insert-btn')
    };

    // Configurar anima√ß√£o do loader
    const imagens = [
      "https://alexandre7888.github.io/CodeHUB/CodeFOX/foto1.jpg",
      "https://alexandre7888.github.io/CodeHUB/CodeFOX/foto2.jpg",
      "https://alexandre7888.github.io/CodeHUB/CodeFOX/foto3.jpg"
    ];

    function startLoaderAnimation() {
      let index = 0;
      loaderInterval = setInterval(() => {
        index = (index + 1) % imagens.length;
        elements.codefoxImage.src = imagens[index];
      }, 2000);
    }

    // Fun√ß√£o para mostrar o conte√∫do principal
    function showAppContent() {
      elements.loadingScreen.style.opacity = '0';
      setTimeout(() => {
        elements.loadingScreen.style.display = 'none';
        elements.appContent.style.display = 'block';
        clearInterval(loaderInterval);
      }, 500);
    }

    // Fun√ß√µes auxiliares
    function encodeKey(str) {
      return btoa(encodeURIComponent(str)).replace(/=/g, '');
    }

    function sanitizeFilename(filename) {
      return filename.replace(/[.#$/[\]]/g, '_');
    }

    // Configura√ß√£o do Monaco Editor
    require.config({ 
      paths: { 
        'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' 
      } 
    });

    window.MonacoEnvironment = { 
      getWorkerUrl: function(moduleId, label) {
        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
          self.MonacoEnvironment = { 
            baseUrl: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/' 
          };
          importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/worker/workerMain.js');
        `)}`;
      }
    };

    // Inicializa√ß√£o do editor
    require(['vs/editor/editor.main'], function() {
      editor = monaco.editor.create(document.getElementById('container'), {
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: { enabled: false },
        language: 'html'
      });

      editor.onDidChangeModelContent(() => {
        if (currentFile) {
          elements.saveFileBtn.disabled = false;
        }
      });

      // Iniciar anima√ß√£o do loader
      startLoaderAnimation();

      // Inicializar aplica√ß√£o
      initializeApp();
    });

    // Fun√ß√£o principal de inicializa√ß√£o
    function initializeApp() {
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'auth.html';
          return;
        }

        currentUser = user;
        updateUserInfo(user);
        saveUserInfo(user);

        // Obter ID do projeto da URL
        const urlParams = new URLSearchParams(window.location.search);
        currentProjectId = urlParams.get('projectId');

        if (!currentProjectId) {
          alert('ID do projeto n√£o encontrado na URL!');
          window.location.href = 'index.html';
          return;
        }

        // Configurar refer√™ncias do Firebase
        projectRef = db.ref(`projects/${user.uid}/${currentProjectId}`);
        sessionRef = db.ref(`sessions/${currentProjectId}`);

        // Configurar listeners
        setupCodeListener();
        loadProject();
        loadUploadedFiles();
        setupEventListeners();
      });
    }

    // Configurar listeners de eventos
    function setupEventListeners() {
      elements.newFileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        createNewFile();
      });

      elements.saveFileBtn.addEventListener('click', saveCurrentFile);

      elements.previewBtn.addEventListener('click', function() {
        if (!currentProjectId) {
          alert('Projeto n√£o carregado corretamente!');
          return;
        }
        window.open(`view.html?projectId=${currentProjectId}`, '_blank');
      });

      elements.projectNameInput.addEventListener('blur', updateProjectName);

      // IA Assistente
      elements.aiBtn.addEventListener('click', function() {
        if (!currentProjectId) {
          alert('Projeto n√£o carregado corretamente!');
          return;
        }
        const aiUrl = `https://pergunte-ia--socialkoala6579904.on.websim.com/?projectId=${currentProjectId}`;
        elements.aiIframe.src = aiUrl;
        elements.aiIframeContainer.style.display = 'flex';
      });

      elements.closeAiBtn.addEventListener('click', function() {
        elements.aiIframeContainer.style.display = 'none';
        elements.aiIframe.src = 'about:blank';
      });

      // Upload de arquivos
      elements.uploadBtn.addEventListener('click', function() {
        if (!currentProjectId) {
          alert('Projeto n√£o carregado corretamente!');
          return;
        }
        const uploadUrl = `https://nuvem-de-arquivos-drive--narrownarwhal3891229.on.websim.com/?projectId=${currentProjectId}`;
        elements.uploadIframe.src = uploadUrl;
        elements.uploadIframeContainer.style.display = 'flex';
      });

      elements.closeUploadBtn.addEventListener('click', function() {
        elements.uploadIframeContainer.style.display = 'none';
        elements.uploadIframe.src = 'about:blank';
        // Recarregar arquivos ap√≥s fechar o upload
        loadProject();
        loadUploadedFiles();
      });

      // Inserir arquivo - CORRE√á√ÉO PRINCIPAL
      elements.insertFileBtn.addEventListener('click', function() {
        showInsertModal();
      });

      elements.cancelInsertBtn.addEventListener('click', function() {
        elements.insertModal.style.display = 'none';
      });

      elements.confirmInsertBtn.addEventListener('click', insertFileReference);

      // Notifica√ß√£o de c√≥digo
      elements.insertCodeBtn.addEventListener('click', insertCode);
      elements.discardCodeBtn.addEventListener('click', function() {
        elements.codeNotification.style.display = 'none';
        currentCode = null;
      });
    }

    // Atualizar informa√ß√µes do usu√°rio na UI
    function updateUserInfo(user) {
      if (!user) return;

      if (user.displayName) {
        elements.userNameElement.textContent = user.displayName;
      } else if (user.email) {
        elements.userNameElement.textContent = user.email.split('@')[0];
      } else {
        elements.userNameElement.textContent = 'Usu√°rio';
      }
    }

    // Salvar informa√ß√µes do usu√°rio no Firebase
    function saveUserInfo(user) {
      if (!user || !user.uid) return;

      const userRef = db.ref(`users/${user.uid}`);
      const userData = {
        name: user.displayName || user.email.split('@')[0],
        email: user.email,
        lastLogin: new Date().toISOString()
      };

      userRef.update(userData).catch(error => {
        console.error("Erro ao salvar informa√ß√µes do usu√°rio:", error);
      });
    }

    // Carregar projeto do Firebase
    function loadProject() {
      if (!projectRef) {
        console.error('Refer√™ncia do projeto n√£o definida');
        return;
      }

      projectRef.on('value', (snapshot) => {
        const projectData = snapshot.val();
        if (!projectData) {
          alert('Projeto n√£o encontrado no banco de dados!');
          window.location.href = 'index.html';
          return;
        }

        // Atualizar nome do projeto
        elements.projectNameInput.value = projectData.name || 'Projeto sem nome';
        files = projectData.files || {};

        // Encontrar arquivo index.html ou o primeiro arquivo dispon√≠vel
        const fileKeys = Object.keys(files);
        const indexHtmlKey = fileKeys.find(key => {
          const file = files[key];
          return file.originalName === 'index.html' || file.name === 'index.html';
        });
        const firstFileKey = indexHtmlKey || (fileKeys.length > 0 ? fileKeys[0] : null);

        if (firstFileKey) {
          openFile(firstFileKey);
        } else {
          // Criar um arquivo index.html padr√£o se n√£o houver arquivos
          createDefaultIndexHtml();
        }

        updateTabs();

        // Mostrar conte√∫do principal ap√≥s carregar tudo
        showAppContent();
      }, (error) => {
        console.error("Erro ao carregar projeto:", error);
        alert("Erro ao carregar o projeto. Por favor, recarregue a p√°gina.");
      });
    }

    // Carregar arquivos enviados pelo WebSim
    function loadUploadedFiles() {
      const uploadedFilesRef = db.ref('projectFiles');
      uploadedFilesRef.orderByChild('projectId').equalTo(currentProjectId).on('value', (snapshot) => {
        uploadedFiles = snapshot.val() || {};
        console.log('Arquivos carregados:', uploadedFiles);
      });
    }

    // Criar arquivo index.html padr√£o
    function createDefaultIndexHtml() {
      const fileName = 'index.html';
      const sanitizedFileName = sanitizeFilename(fileName);
      const fileKey = encodeKey(sanitizedFileName);

      files[fileKey] = { 
        name: sanitizedFileName, 
        originalName: fileName,
        content: `<!DOCTYPE html>
<html>
<head>
  <title>Novo Projeto</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
  </style>
</head>
<body>
  <h1>Novo Projeto</h1>
  <p>Comece a editar seu c√≥digo aqui!</p>
</body>
</html>`, 
        language: 'html',
        createdAt: new Date().toISOString()
      };

      updateFirebaseFiles();
      openFile(fileKey);
    }

    // Criar novo arquivo
    function createNewFile() {
      const fileName = elements.newFileNameInput.value.trim();
      if (!fileName) {
        alert('Por favor, insira um nome de arquivo v√°lido.');
        return;
      }

      const sanitizedFileName = sanitizeFilename(fileName);
      const fileKey = encodeKey(sanitizedFileName);

      // Verificar se arquivo j√° existe
      const existingFile = Object.values(files).find(f => 
        f.name === fileName || f.originalName === fileName
      );

      if (existingFile) {
        alert('Um arquivo com este nome j√° existe.');
        return;
      }

      // Verificar se √© um arquivo enviado pelo WebSim
      const uploadedFile = findUploadedFileByName(fileName);
      
      if (uploadedFile) {
        // Se for um arquivo enviado, criar um arquivo com a URL
        files[fileKey] = { 
          name: sanitizedFileName, 
          originalName: fileName,
          url: uploadedFile.url,
          isUploadedFile: true,
          createdAt: new Date().toISOString()
        };
      } else {
        // Determinar conte√∫do padr√£o baseado na extens√£o
        let content = '';
        const extension = fileName.split('.').pop().toLowerCase();
        const language = extension;

        switch(extension) {
          case 'html':
            content = `<!DOCTYPE html>
<html>
<head>
  <title>${fileName}</title>
  <style>
  </style>
</head>
<body>
</body>
</html>`;
            break;
          case 'css':
            content = `/* ${fileName} */`;
            break;
          case 'js':
            content = `// ${fileName}`;
            break;
          default:
            content = `// ${fileName}`;
        }

        // Criar novo arquivo
        files[fileKey] = { 
          name: sanitizedFileName, 
          originalName: fileName,
          content: content, 
          language: language,
          createdAt: new Date().toISOString()
        };
      }

      updateFirebaseFiles();
      openFile(fileKey);
      elements.newFileNameInput.value = '';
    }

    // Encontrar arquivo enviado pelo nome
    function findUploadedFileByName(fileName) {
      for (const key in uploadedFiles) {
        if (uploadedFiles[key].originalName === fileName) {
          return uploadedFiles[key];
        }
      }
      return null;
    }

    // Abrir arquivo no editor
    function openFile(fileKey) {
      if (!files[fileKey] || !editor) {
        console.error('Arquivo ou editor n√£o dispon√≠vel');
        return;
      }

      currentFile = fileKey;
      const fileData = files[fileKey];

      // Se for um arquivo enviado (com URL), mostrar na visualiza√ß√£o de arquivo
      if (fileData.url) {
        showUploadedFile(fileData);
        return;
      }

      // Caso contr√°rio, √© um arquivo de texto - abrir no editor
      elements.fileContainer.style.display = 'none';
      editor.getDomNode().style.display = 'block';

      // Determinar linguagem
      let language;
      switch(fileData.language) {
        case 'html': language = 'html'; break;
        case 'css': language = 'css'; break;
        case 'js': language = 'javascript'; break;
        default: language = 'plaintext';
      }

      // Criar ou reutilizar modelo
      let model = models[fileKey];
      if (!model) {
        model = monaco.editor.createModel(
          fileData.content,
          language,
          monaco.Uri.parse(`file:///${fileData.originalName || fileData.name}`)
        );
        models[fileKey] = model;
      }

      // Definir modelo no editor
      editor.setModel(model);
      monaco.editor.setModelLanguage(model, language);
      updateTabs();
      elements.saveFileBtn.disabled = true;
    }

    // Mostrar arquivo enviado em um iframe
    function showUploadedFile(fileData) {
      editor.getDomNode().style.display = 'none';
      elements.fileContainer.style.display = 'block';
      elements.fileIframe.src = fileData.url;
      
      updateTabs();
      elements.saveFileBtn.disabled = true;
    }

    // Atualizar abas de arquivos
    function updateTabs() {
      elements.tabsContainer.innerHTML = '';
      Object.keys(files).forEach(fileKey => {
        const fileData = files[fileKey];
        const tab = document.createElement('button');
        tab.className = `tab-btn ${fileKey === currentFile ? 'active' : ''}`;
        tab.onclick = () => openFile(fileKey);

        const label = document.createElement('span');
        label.textContent = fileData.originalName || fileData.name;
        tab.appendChild(label);

        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-tab-btn';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeFile(fileKey);
        };
        tab.appendChild(closeBtn);

        elements.tabsContainer.appendChild(tab);
      });
    }

    // Fechar arquivo
    function closeFile(fileKey) {
      if (Object.keys(files).length <= 1) {
        alert('Voc√™ n√£o pode fechar o √∫ltimo arquivo do projeto.');
        return;
      }

      const model = models[fileKey];
      if (model) {
        model.dispose();
        delete models[fileKey];
      }

      delete files[fileKey];
      updateFirebaseFiles();

      if (fileKey === currentFile) {
        currentFile = null;
        openFile(Object.keys(files)[0]);
      }
      updateTabs();
    }

    // Salvar arquivo atual
    function saveCurrentFile() {
      if (!currentFile || !editor) return;

      const model = editor.getModel();
      if (model) {
        files[currentFile].content = model.getValue();
        files[currentFile].updatedAt = new Date().toISOString();

        // Atualizar Firebase com os arquivos e a data de atualiza√ß√£o
        projectRef.update({
          files: files,
          updatedAt: new Date().toISOString()
        })
        .then(() => {
          elements.saveFileBtn.disabled = true;
          elements.saveFileBtn.textContent = 'Salvo!';
          setTimeout(() => { 
            elements.saveFileBtn.textContent = 'üíæ Salvar';
          }, 1500);
        })
        .catch(error => {
          console.error('Erro ao salvar arquivo:', error);
          alert('Falha ao salvar o arquivo. Por favor, tente novamente.');
        });
      }
    }

    // Atualizar arquivos no Firebase
    function updateFirebaseFiles(callback) {
      if (!projectRef) {
        console.error('Refer√™ncia do projeto n√£o definida');
        return;
      }

      projectRef.update({
        files: files,
        updatedAt: new Date().toISOString()
      })
        .then(() => {
          if (callback) callback();
        })
        .catch(error => {
          console.error('Erro ao salvar arquivos:', error);
          alert('Falha ao salvar os arquivos. Por favor, tente novamente.');
        });
    }

    // Atualizar nome do projeto
    function updateProjectName() {
      const newName = elements.projectNameInput.value.trim();
      if (!newName) {
        alert('O nome do projeto n√£o pode ser vazio.');
        projectRef.child('name').once('value', snapshot => {
          elements.projectNameInput.value = snapshot.val() || '';
        });
        return;
      }

      projectRef.update({
        name: newName,
        updatedAt: new Date().toISOString()
      });
    }

    // Monitorar c√≥digos recebidos da IA
    function setupCodeListener() {
      if (!sessionRef) {
        console.error('Refer√™ncia de sess√£o n√£o definida');
        return;
      }

      sessionRef.child('codes').on('child_added', (snapshot) => {
        const codeData = snapshot.val();
        if (codeData && codeData.code) {
          console.log('Novo c√≥digo recebido:', codeData);
          showCodeNotification(codeData);
        }
      }, (error) => {
        console.error('Erro ao monitorar c√≥digos:', error);
      });
    }

    // Mostrar notifica√ß√£o de novo c√≥digo
    function showCodeNotification(codeData) {
      currentCode = codeData;
      elements.codePreview.textContent = codeData.code;

      // Preencher seletor de arquivos
      elements.targetFileSelect.innerHTML = '';
      Object.keys(files).forEach(fileKey => {
        const fileData = files[fileKey];
        // Apenas arquivos de texto podem receber c√≥digo
        if (!fileData.url) {
          const option = document.createElement('option');
          option.value = fileKey;
          option.textContent = fileData.originalName || fileData.name;
          elements.targetFileSelect.appendChild(option);
        }
      });

      elements.codeNotification.style.display = 'block';
    }

    // Inserir c√≥digo no arquivo selecionado
    function insertCode() {
      if (!currentCode) {
        console.error('Nenhum c√≥digo para inserir');
        return;
      }

      const selectedFileKey = elements.targetFileSelect.value;
      if (!selectedFileKey || !files[selectedFileKey]) {
        console.error('Arquivo selecionado inv√°lido');
        return;
      }

      // Adicionar c√≥digo ao arquivo (apenas para arquivos de texto)
      if (files[selectedFileKey].url) {
        alert('N√£o √© poss√≠vel inserir c√≥digo em arquivos de m√≠dia.');
        return;
      }

      files[selectedFileKey].content = files[selectedFileKey].content + '\n' + currentCode.code;

      // Atualizar Firebase
      updateFirebaseFiles(() => {
        console.log('C√≥digo inserido com sucesso no arquivo:', selectedFileKey);

        // Atualizar editor
        if (selectedFileKey === currentFile) {
          const model = editor.getModel();
          if (model) {
            model.setValue(files[selectedFileKey].content);
          }
        } else {
          openFile(selectedFileKey);
        }

        // Fechar notifica√ß√£o
        elements.codeNotification.style.display = 'none';
        currentCode = null;
      });
    }

    // Mostrar modal para inserir arquivo
    function showInsertModal() {
      // Limpar sele√ß√µes anteriores
      elements.fileSelect.innerHTML = '<option value="">Selecione um arquivo</option>';
      
      // Preencher com arquivos dispon√≠veis
      for (const key in uploadedFiles) {
        const file = uploadedFiles[key];
        const option = document.createElement('option');
        option.value = key;
        option.textContent = file.originalName;
        elements.fileSelect.appendChild(option);
      }
      
      elements.insertModal.style.display = 'flex';
    }

    // Inserir refer√™ncia de arquivo no c√≥digo (apenas iframe) - CORRE√á√ÉO PRINCIPAL
    function insertFileReference() {
      const selectedFileKey = elements.fileSelect.value;
      
      if (!selectedFileKey) {
        showInsertStatus('Por favor, selecione um arquivo.', 'error');
        return;
      }
      
      const file = uploadedFiles[selectedFileKey];
      if (!file) {
        showInsertStatus('Arquivo n√£o encontrado.', 'error');
        return;
      }
      
      // Gerar c√≥digo iframe
      const codeToInsert = `<iframe src="${file.url}" frameborder="0" style="width:100%; height:400px;"></iframe>`;
      
      // Inserir no editor atual
      if (editor && currentFile && files[currentFile] && !files[currentFile].url) {
        const model = editor.getModel();
        if (model) {
          // Obter posi√ß√£o atual do cursor
          const position = editor.getPosition();
          
          // Inserir o c√≥digo na posi√ß√£o atual
          const range = new monaco.Range(
            position.lineNumber,
            position.column,
            position.lineNumber,
            position.column
          );
          
          const id = { major: 1, minor: 1 };
          const op = { 
            identifier: id, 
            range: range, 
            text: codeToInsert, 
            forceMoveMarkers: true 
          };
          
          model.applyEdits([op]);
          
          showInsertStatus('Arquivo inserido com sucesso!', 'success');
          setTimeout(() => {
            elements.insertModal.style.display = 'none';
            elements.insertStatus.style.display = 'none';
          }, 1500);
        } else {
          showInsertStatus('Erro: Editor n√£o est√° dispon√≠vel.', 'error');
        }
      } else {
        showInsertStatus('Erro: N√£o √© poss√≠vel inserir arquivo neste tipo de arquivo.', 'error');
      }
    }

    // Mostrar status da opera√ß√£o de inser√ß√£o
    function showInsertStatus(message, type) {
      elements.insertStatus.textContent = message;
      elements.insertStatus.className = 'status-' + type;
      elements.insertStatus.style.display = 'block';
    }
  </script>
</body>
</html>