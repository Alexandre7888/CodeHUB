<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Editor CodeHub</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      display: flex; flex-direction: column;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #controls {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #1e1e1e;
      color: white;
      align-items: center;
    }
    #tabs {
      display: flex;
      border-bottom: 1px solid #333;
      background: #252526;
      align-items: center;
      gap: 5px;
      padding-left: 10px;
      overflow-x: auto;
    }
    #tabs button.tab-btn {
      background: #2d2d2d;
      border: none;
      color: #d4d4d4;
      padding: 8px 15px;
      cursor: pointer;
      position: relative;
      user-select: none;
      white-space: nowrap;
      border-right: 1px solid #1e1e1e;
    }
    #tabs button.tab-btn.active {
      background: #1e1e1e;
      color: white;
    }
    #tabs button.close-btn {
      position: absolute;
      top: 3px;
      right: 5px;
      background: transparent;
      border: none;
      color: #bbb;
      cursor: pointer;
      font-size: 12px;
    }
    button {
      background: #0e639c;
      border: none;
      color: white;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #saveFileBtn { background: #388a3f; }
    #previewBtn { background: #68217a; }
    #viewBtn { background: #007acc; }
    #shareBtn { background: #4d4d4d; margin-left: auto; }
    #githubBtn { background: #24292e; }
    #container {
      flex: 1;
      overflow: hidden;
    }
    #newFileForm {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    #newFileForm input {
      padding: 5px 8px;
      border-radius: 2px;
      border: 1px solid #333;
      background: #252526;
      color: white;
      outline: none;
      width: 200px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background-color: #252526;
      margin: 10% auto;
      padding: 20px;
      border-radius: 4px;
      width: 90%;
      max-width: 500px;
      color: white;
    }
    .close-btn {
      float: right;
      cursor: pointer;
    }
    .input-group {
      display: flex;
      margin-top: 10px;
    }
    .input-group input {
      flex: 1;
      padding: 8px;
      background: #333;
      border: 1px solid #444;
      color: white;
    }
    .input-group button {
      border-radius: 0 2px 2px 0;
    }
    .read-only-warning {
      background: #4b3800;
      color: #ffcc00;
      padding: 8px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>
<body>
  <div id="controls">
    <form id="newFileForm">
      <input type="text" id="newFileName" placeholder="Nome do arquivo (ex: script.js)" required />
      <button type="submit">Criar arquivo</button>
    </form>
    <button id="saveFileBtn">üíæ Salvar</button>
    <button id="previewBtn">üëÅÔ∏è Visualizar</button>
    <button id="viewBtn">üîó Link Visualiza√ß√£o</button>
    <button id="githubBtn">üêô Publicar no GitHub</button>
    <button id="shareBtn">üë• Compartilhar</button>
  </div>

  <div id="tabs"></div>

  <div id="container" style="height: calc(100vh - 90px);"></div>

  <div id="share-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3>Compartilhar Projeto</h3>
      <div class="form-group">
        <label>Link de Visualiza√ß√£o:</label>
        <div class="input-group">
          <input type="text" id="view-link" readonly>
          <button type="button" id="copy-view-link">Copiar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="github-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3>Publicar no GitHub</h3>
      <div id="github-login">
        <p>Conecte-se com o GitHub para publicar seu projeto:</p>
        <button id="connect-github">Conectar com GitHub</button>
      </div>
      <div id="github-publish" style="display: none;">
        <div class="form-group">
          <label>Reposit√≥rio:</label>
          <input type="text" id="github-repo" placeholder="nome-do-repositorio">
        </div>
        <div class="form-group">
          <label>Branch:</label>
          <input type="text" id="github-branch" value="main" placeholder="main">
        </div>
        <button id="publish-github">Publicar</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:7cc5bde34f4c5a5ce41b32",
      measurementId: "G-V57KRZ02HJ"
    };

    // Inicializar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, set, remove } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Configura√ß√£o do GitHub
    const githubClientId = "Ov23liphSw7QXqfsbj7f";
    const githubRedirectUri = window.location.href.includes('localhost') 
      ? 'http://localhost:5500/editor.html' 
      : 'https://seu-site.com/editor.html';
    
    // Vari√°veis globais
    let editor;
    let currentProjectId;
    let currentFile = null;
    let files = {};
    let isReadOnly = false;
    let userUid = null;

    // Inicializar Monaco Editor
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      editor = monaco.editor.create(document.getElementById('container'), {
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: { enabled: false }
      });
      
      // Atualizar conte√∫do quando o editor mudar
      editor.onDidChangeModelContent(() => {
        if (currentFile && !isReadOnly) {
          document.getElementById('saveFileBtn').disabled = false;
        }
      });
    });

    // Quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', () => {
      // Obter ID do projeto da URL
      const urlParams = new URLSearchParams(window.location.search);
      currentProjectId = urlParams.get('projectId');
      const viewToken = urlParams.get('token');
      
      if (viewToken) {
        isReadOnly = true;
        document.getElementById('read-only-warning').style.display = 'block';
        document.getElementById('controls').style.display = 'none';
        loadProjectByToken(viewToken);
      } else if (currentProjectId) {
        setupAuth();
      } else {
        window.location.href = 'index.html';
      }

      // Configurar eventos
      document.getElementById('newFileForm').addEventListener('submit', createNewFile);
      document.getElementById('saveFileBtn').addEventListener('click', saveCurrentFile);
      document.getElementById('previewBtn').addEventListener('click', previewFile);
      document.getElementById('viewBtn').addEventListener('click', showViewLink);
      document.getElementById('shareBtn').addEventListener('click', () => {
        document.getElementById('share-modal').style.display = 'block';
      });
      document.getElementById('githubBtn').addEventListener('click', () => {
        document.getElementById('github-modal').style.display = 'block';
      });
      document.getElementById('connect-github').addEventListener('click', connectGitHub);
      document.getElementById('publish-github').addEventListener('click', publishToGitHub);
      
      // Fechar modais
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.modal').style.display = 'none';
        });
      });
    });

    // Configurar autentica√ß√£o
    function setupAuth() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userUid = user.uid;
          loadProject(user.uid);
        } else {
          window.location.href = 'auth.html';
        }
      });
    }

    // Carregar projeto
    function loadProject(userId) {
      const projectRef = ref(database, `projects/${userId}/${currentProjectId}`);
      
      onValue(projectRef, (snapshot) => {
        const projectData = snapshot.val();
        if (projectData) {
          files = projectData.files || {};
          openFirstFile();
          updateViewLink();
        }
      });
    }

    // Carregar projeto por token
    function loadProjectByToken(token) {
      const tokenRef = ref(database, `tokens/${token}`);
      
      onValue(tokenRef, (snapshot) => {
        const tokenData = snapshot.val();
        if (tokenData) {
          currentProjectId = tokenData.projectId;
          const projectRef = ref(database, `projects/${tokenData.ownerId}/${currentProjectId}`);
          
          onValue(projectRef, (snapshot) => {
            const projectData = snapshot.val();
            if (projectData) {
              files = projectData.files || {};
              openFirstFile();
            }
          });
        }
      });
    }

    // Abrir o primeiro arquivo
    function openFirstFile() {
      const fileNames = Object.keys(files);
      if (fileNames.length > 0) {
        openFile(fileNames[0]);
      }
    }

    // Criar novo arquivo
    function createNewFile(e) {
      e.preventDefault();
      const fileName = document.getElementById('newFileName').value.trim();
      
      if (!fileName) return;
      
      const fileExt = fileName.split('.').pop().toLowerCase();
      let initialContent = '';
      
      // Conte√∫do inicial baseado no tipo de arquivo
      switch(fileExt) {
        case 'html':
          initialContent = `<!DOCTYPE html>
<html>
<head>
  <title>Novo Arquivo</title>
</head>
<body>
  <h1>Novo Arquivo HTML</h1>
</body>
</html>`;
          break;
        case 'css':
          initialContent = `/* Estilos CSS */\nbody {\n  margin: 0;\n  padding: 0;\n}`;
          break;
        case 'js':
          initialContent = `// C√≥digo JavaScript\nfunction init() {\n  console.log('Aplica√ß√£o iniciada');\n}\n\ninit();`;
          break;
        default:
          initialContent = `// ${fileName}`;
      }
      
      files[fileName] = {
        content: initialContent,
        language: fileExt,
        createdAt: new Date().toISOString()
      };
      
      // Salvar no Firebase
      if (!isReadOnly) {
        updateProject();
      }
      
      openFile(fileName);
      document.getElementById('newFileName').value = '';
    }

    // Abrir arquivo no editor
    function openFile(fileName) {
      if (!files[fileName]) return;
      
      currentFile = fileName;
      const fileData = files[fileName];
      
      // Configurar linguagem do editor
      let language;
      switch(fileData.language) {
        case 'html': language = 'html'; break;
        case 'css': language = 'css'; break;
        case 'js': language = 'javascript'; break;
        default: language = 'plaintext';
      }
      
      // Criar ou reutilizar modelo do editor
      let model = monaco.editor.getModels().find(m => m.uri.path === `/${fileName}`);
      
      if (!model) {
        model = monaco.editor.createModel(
          fileData.content,
          language,
          monaco.Uri.parse(`file:///${fileName}`)
        );
      }
      
      editor.setModel(model);
      updateTabs();
    }

    // Atualizar abas
    function updateTabs() {
      const tabsContainer = document.getElementById('tabs');
      tabsContainer.innerHTML = '';
      
      Object.keys(files).forEach(fileName => {
        const tab = document.createElement('button');
        tab.className = `tab-btn ${fileName === currentFile ? 'active' : ''}`;
        tab.textContent = fileName;
        tab.onclick = () => openFile(fileName);
        
        if (!isReadOnly) {
          const closeBtn = document.createElement('span');
          closeBtn.className = 'close-btn';
          closeBtn.innerHTML = '&times;';
          closeBtn.onclick = (e) => {
            e.stopPropagation();
            closeFile(fileName);
          };
          tab.appendChild(closeBtn);
        }
        
        tabsContainer.appendChild(tab);
      });
    }

    // Fechar arquivo
    function closeFile(fileName) {
      if (Object.keys(files).length <= 1) {
        alert('Voc√™ n√£o pode fechar o √∫ltimo arquivo.');
        return;
      }
      
      delete files[fileName];
      updateProject();
      
      // Abrir outro arquivo se estiver fechando o atual
      if (fileName === currentFile) {
        openFile(Object.keys(files)[0]);
      }
    }

    // Salvar arquivo atual
    function saveCurrentFile() {
      if (!currentFile || isReadOnly) return;
      
      const model = editor.getModel();
      if (model) {
        files[currentFile].content = model.getValue();
        updateProject();
        document.getElementById('saveFileBtn').disabled = true;
      }
    }

    // Atualizar projeto no Firebase
    function updateProject() {
      if (isReadOnly || !userUid) return;
      
      const projectRef = ref(database, `projects/${userUid}/${currentProjectId}`);
      update(projectRef, { 
        files: files,
        updatedAt: new Date().toISOString()
      });
    }

    // Visualizar arquivo HTML
    function previewFile() {
      if (!currentFile || !currentFile.endsWith('.html')) {
        alert('Apenas arquivos HTML podem ser visualizados.');
        return;
      }
      
      const content = files[currentFile].content;
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(content);
      previewWindow.document.close();
    }

    // Gerar token de visualiza√ß√£o
    function generateViewToken() {
      const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      const tokenRef = ref(database, `tokens/${token}`);
      
      set(tokenRef, {
        projectId: currentProjectId,
        ownerId: userUid,
        createdAt: new Date().toISOString()
      });
      
      return token;
    }

    // Atualizar link de visualiza√ß√£o
    function updateViewLink() {
      const token = generateViewToken();
      const viewLink = `${window.location.origin}/viewer.html?token=${token}`;
      document.getElementById('view-link').value = viewLink;
    }

    // Mostrar link de visualiza√ß√£o
    function showViewLink() {
      updateViewLink();
      document.getElementById('share-modal').style.display = 'block';
    }

    // Conectar com GitHub
    function connectGitHub() {
      const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${githubClientId}&redirect_uri=${encodeURIComponent(githubRedirectUri)}&scope=repo`;
      window.location.href = githubAuthUrl;
    }

    // Publicar no GitHub
    function publishToGitHub() {
      alert('Funcionalidade de publica√ß√£o no GitHub ser√° implementada aqui');
      // Implementar l√≥gica de publica√ß√£o no GitHub
    }
  </script>
</body>
</html>