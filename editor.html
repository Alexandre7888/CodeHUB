<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Projeto</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      display: flex; flex-direction: column;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: white;
    }

    #top-bar {
      display: flex;
      padding: 10px;
      background: #1e1e1e;
      color: white;
      align-items: center;
      border-bottom: 1px solid #333;
      flex-wrap: wrap;
      gap: 10px;
    }

    #project-name {
      font-size: 1.1em;
      font-weight: bold;
      background: transparent;
      color: white;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 5px;
      margin-right: 10px;
      flex: 1;
      max-width: 300px;
    }

    #project-name:hover { border-color: #555; }
    #project-name:focus { outline: 1px solid #4895ef; }

    #newFileForm {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    #newFileForm input {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #252526;
      color: white;
      outline: none;
      width: 150px;
    }

    button {
      background: #4361ee;
      border: none;
      color: white;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    button:hover {
      filter: brightness(1.2);
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
      color: #999;
    }

    #saveFileBtn { background: #4cc9f0; }
    #previewBtn { background: #4895ef; }
    #aiBtn { background: #7209b7; }

    #tabs {
      display: flex;
      background: #252526;
      align-items: center;
      gap: 1px;
      overflow-x: auto;
    }

    #tabs button.tab-btn {
      background: #2d2d2d;
      border: none;
      color: #d4d4d4;
      padding: 8px 15px;
      cursor: pointer;
      position: relative;
      user-select: none;
      white-space: nowrap;
      border-right: 1px solid #1e1e1e;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #tabs button.tab-btn.active {
      background: #1e1e1e;
      color: white;
    }

    #tabs button.tab-btn .close-tab-btn {
      background: transparent;
      border: none;
      color: #bbb;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      line-height: 1;
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    #tabs button.tab-btn .close-tab-btn:hover {
      background: #555;
      color: white;
    }

    #container {
      flex: 1;
      overflow: hidden;
      height: calc(100vh - 100px);
      position: relative;
    }

    .back-btn {
      background: #6c757d;
      text-decoration: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #user-info {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #user-name {
      font-size: 0.9em;
      color: #ccc;
    }

    #ai-iframe-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1e1e1e;
      z-index: 100;
      display: none;
      flex-direction: column;
    }

    #ai-iframe-header {
      padding: 10px;
      background: #252526;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #ai-iframe {
      flex: 1;
      border: none;
      background: white;
    }

    #close-ai-btn {
      background: #f72585;
      padding: 5px 10px;
      border-radius: 4px;
    }

    #code-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #252526;
      border: 1px solid #4361ee;
      border-radius: 8px;
      padding: 15px;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
    }

    #code-notification h3 {
      margin-top: 0;
      color: #4cc9f0;
    }

    #code-notification pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 200px;
    }

    #code-notification-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #code-notification-buttons button {
      flex: 1;
    }

    #insert-code-btn {
      background: #4cc9f0;
    }

    #discard-code-btn {
      background: #f72585;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" crossOrigin="anonymous"></script>
</head>
<body>
  <div id="top-bar">
    <a href="index.html" class="back-btn">‚Üê Voltar</a>
    <input type="text" id="project-name" value="Carregando..."/>
    <form id="newFileForm">
      <input type="text" id="newFileName" placeholder="ex: script.js" required/>
      <button type="submit">Criar arquivo</button>
    </form>
    <button id="saveFileBtn" disabled>üíæ Salvar</button>
    <button id="previewBtn">üëÅÔ∏è Visualizar</button>
    <button id="aiBtn">ü§ñ IA Assistente</button>
    <div id="user-info">
      <span id="user-name">Carregando...</span>
    </div>
  </div>

  <div id="tabs"></div>

  <div id="container">
    <div id="ai-iframe-container">
      <div id="ai-iframe-header">
        <h3>Assistente de IA</h3>
        <button id="close-ai-btn">Fechar</button>
      </div>
      <iframe id="ai-iframe" src="about:blank"></iframe>
    </div>
  </div>

  <div id="code-notification">
    <h3>Novo c√≥digo recebido da IA!</h3>
    <p>Selecione em qual arquivo deseja inserir:</p>
    <select id="target-file-select">
      <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
    </select>
    <pre id="code-preview"></pre>
    <div id="code-notification-buttons">
      <button id="insert-code-btn">Inserir</button>
      <button id="discard-code-btn">Descartar</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:1ac651348e624f6be41b32",
      measurementId: "G-7E1VWN07GM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let editor;
    let currentProjectId;
    let currentFile = null;
    let projectRef = null;
    let files = {};
    let models = {};
    let currentUser = null;
    let sessionRef = null;
    let currentCode = null;

    const newFileNameInput = document.getElementById('newFileName');
    const newFileForm = document.getElementById('newFileForm');
    const saveFileBtn = document.getElementById('saveFileBtn');
    const previewBtn = document.getElementById('previewBtn');
    const aiBtn = document.getElementById('aiBtn');
    const projectNameInput = document.getElementById('project-name');
    const tabsContainer = document.getElementById('tabs');
    const userNameElement = document.getElementById('user-name');
    const aiIframeContainer = document.getElementById('ai-iframe-container');
    const aiIframe = document.getElementById('ai-iframe');
    const closeAiBtn = document.getElementById('close-ai-btn');
    const codeNotification = document.getElementById('code-notification');
    const codePreview = document.getElementById('code-preview');
    const targetFileSelect = document.getElementById('target-file-select');
    const insertCodeBtn = document.getElementById('insert-code-btn');
    const discardCodeBtn = document.getElementById('discard-code-btn');

    function encodeKey(str) {
      return btoa(str).replace(/=/g, '');
    }

    function sanitizeFilename(filename) {
      return filename.replace(/[.#$/[\]]/g, '_');
    }

    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
    window.MonacoEnvironment = { getWorkerUrl: () => `data:text/javascript;charset=utf-8,${encodeURIComponent(`
        self.MonacoEnvironment = { baseUrl: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/' };
        importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/worker/workerMain.js');`
    )}`};

    require(['vs/editor/editor.main'], function() {
      editor = monaco.editor.create(document.getElementById('container'), {
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: { enabled: false }
      });

      editor.onDidChangeModelContent(() => {
        if (currentFile) {
          saveFileBtn.disabled = false;
        }
      });
      main();
    });

    function main() {
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'auth.html';
          return;
        }

        currentUser = user;
        
        // Atualizar informa√ß√µes do usu√°rio na UI
        updateUserInfo(user);

        // Salvar informa√ß√µes do usu√°rio no banco de dados
        saveUserInfo(user);

        const urlParams = new URLSearchParams(window.location.search);
        currentProjectId = urlParams.get('projectId');

        if (!currentProjectId) {
          alert('ID do projeto n√£o encontrado!');
          window.location.href = 'index.html';
          return;
        }

        projectRef = db.ref(`projects/${user.uid}/${currentProjectId}`);
        sessionRef = db.ref(`sessions/${currentProjectId}`);
        
        // Monitorar c√≥digos recebidos da IA
        setupCodeListener();
        
        loadProject();

        newFileForm.addEventListener('submit', createNewFile);
        saveFileBtn.addEventListener('click', saveCurrentFile);
        previewBtn.addEventListener('click', () => window.open(`view.html?projectId=${currentProjectId}`, '_blank'));
        projectNameInput.addEventListener('blur', updateProjectName);
        
        // Configurar eventos do bot√£o de IA
        aiBtn.addEventListener('click', () => {
          const aiUrl = `https://pergunte-ia--socialkoala6579904.on.websim.com/?projectId=${currentProjectId}`;
          aiIframe.src = aiUrl;
          aiIframeContainer.style.display = 'flex';
        });
        
        closeAiBtn.addEventListener('click', () => {
          aiIframeContainer.style.display = 'none';
          aiIframe.src = 'about:blank';
        });

        // Configurar eventos da notifica√ß√£o de c√≥digo
        insertCodeBtn.addEventListener('click', insertCode);
        discardCodeBtn.addEventListener('click', () => {
          codeNotification.style.display = 'none';
          currentCode = null;
        });
      });
    }

    function setupCodeListener() {
      if (!sessionRef) return;
      
      sessionRef.child('codes').on('child_added', (snapshot) => {
        const codeData = snapshot.val();
        if (codeData && codeData.code) {
          showCodeNotification(codeData);
        }
      });
    }

    function showCodeNotification(codeData) {
      currentCode = codeData;
      codePreview.textContent = codeData.code;
      
      // Preencher o select com os arquivos dispon√≠veis
      targetFileSelect.innerHTML = '';
      Object.keys(files).forEach(fileKey => {
        const fileData = files[fileKey];
        const option = document.createElement('option');
        option.value = fileKey;
        option.textContent = fileData.originalName || fileData.name;
        targetFileSelect.appendChild(option);
      });
      
      codeNotification.style.display = 'block';
    }

    function insertCode() {
      if (!currentCode) return;
      
      const selectedFileKey = targetFileSelect.value;
      if (!selectedFileKey || !files[selectedFileKey]) return;
      
      // Adicionar o c√≥digo ao arquivo selecionado
      const fileContent = files[selectedFileKey].content;
      files[selectedFileKey].content = fileContent + '\n' + currentCode.code;
      
      // Atualizar o Firebase
      updateFirebaseFiles();
      
      // Abrir o arquivo se n√£o estiver aberto
      if (selectedFileKey !== currentFile) {
        openFile(selectedFileKey);
      } else {
        // Recarregar o arquivo se j√° estiver aberto
        const model = editor.getModel();
        if (model) {
          model.setValue(files[selectedFileKey].content);
        }
      }
      
      // Fechar a notifica√ß√£o
      codeNotification.style.display = 'none';
      currentCode = null;
    }

    function updateUserInfo(user) {
      if (user.displayName) {
        userNameElement.textContent = user.displayName;
      } else if (user.email) {
        userNameElement.textContent = user.email.split('@')[0];
      } else {
        userNameElement.textContent = 'Usu√°rio';
      }
    }

    function saveUserInfo(user) {
      const userRef = db.ref(`users/${user.uid}`);

      const userData = {
        name: user.displayName || user.email.split('@')[0],
        email: user.email,
        lastLogin: new Date().toISOString()
      };

      userRef.update(userData, (error) => {
        if (error) {
          console.error("Erro ao salvar informa√ß√µes do usu√°rio:", error);
        }
      });

      // Adicionar o ID do usu√°rio ao projeto
      if (currentProjectId) {
        const projectUserRef = db.ref(`projects/${user.uid}/${currentProjectId}/user`);
        projectUserRef.set({
          uid: user.uid,
          name: user.displayName || user.email.split('@')[0],
          email: user.email
        });
      }
    }

    function loadProject() {
        projectRef.on('value', (snapshot) => {
            const projectData = snapshot.val();
            if (projectData) {
                projectNameInput.value = projectData.name || 'Projeto sem nome';
                files = projectData.files || {};

                const fileKeys = Object.keys(files);
                const indexHtmlKey = fileKeys.find(key => {
                  const file = files[key];
                  return file.originalName === 'index.html' || file.name === 'index.html';
                });
                const firstFileKey = indexHtmlKey || (fileKeys.length > 0 ? fileKeys[0] : null);

                if (firstFileKey) {
                    if (!currentFile) {
                        openFile(firstFileKey);
                    }
                    updateTabs();
                }
            } else {
                 alert('Projeto n√£o encontrado!');
                 window.location.href = 'index.html';
            }
        }, (error) => {
            console.error("Firebase read failed:", error);
            alert("Erro ao carregar o projeto.");
        });
    }

    function createNewFile(e) {
      e.preventDefault();
      const fileName = newFileNameInput.value.trim();
      if (!fileName) {
          alert('Nome de arquivo inv√°lido.');
          return;
      }

      const sanitizedFileName = sanitizeFilename(fileName);
      const fileKey = encodeKey(sanitizedFileName);

      const existingFile = Object.values(files).find(f => 
        f.name === fileName || f.originalName === fileName
      );

      if (existingFile) {
          alert('Um arquivo com este nome j√° existe.');
          return;
      }

      let content = '';
      const extension = fileName.split('.').pop().toLowerCase();
      const language = extension;

      switch(extension) {
        case 'html':
          content = `<!DOCTYPE html>
<html>
<head>
  <title>${fileName}</title>
  <style>
  </style>
</head>
<body>
</body>
</html>`;
          break;
        case 'css':
          content = `/* ${fileName} */`;
          break;
        case 'js':
          content = `// ${fileName}`;
          break;
        default:
          content = `// ${fileName}`;
      }

      files[fileKey] = { 
        name: sanitizedFileName, 
        originalName: fileName,
        content: content, 
        language: language,
        createdAt: new Date().toISOString()
      };

      updateFirebaseFiles();
      openFile(fileKey);
      newFileNameInput.value = '';
    }

    function openFile(fileKey) {
      if (!files[fileKey] || !editor) return;
      currentFile = fileKey;
      const fileData = files[fileKey];

      let language;
      switch(fileData.language) {
        case 'html': language = 'html'; break;
        case 'css': language = 'css'; break;
        case 'js': language = 'javascript'; break;
        default: language = 'plaintext';
      }

      let model = models[fileKey];
      if (!model) {
        model = monaco.editor.createModel(
          fileData.content,
          language,
          monaco.Uri.parse(`file:///${fileData.originalName || fileData.name}`)
        );
        models[fileKey] = model;
      }

      editor.setModel(model);
      updateTabs();
      saveFileBtn.disabled = true;
    }

    function closeFile(e, fileKey) {
        e.stopPropagation();
        if (Object.keys(files).length <= 1) {
            alert('Voc√™ n√£o pode fechar o √∫ltimo arquivo do projeto.');
            return;
        }

        const model = models[fileKey];
        if (model) {
            model.dispose();
            delete models[fileKey];
        }

        delete files[fileKey];
        updateFirebaseFiles();

        if (fileKey === currentFile) {
            currentFile = null;
            openFile(Object.keys(files)[0]);
        }
        updateTabs();
    }

    function updateTabs() {
      tabsContainer.innerHTML = '';
      Object.keys(files).forEach(fileKey => {
        const fileData = files[fileKey];
        const tab = document.createElement('button');
        tab.className = `tab-btn ${fileKey === currentFile ? 'active' : ''}`;
        tab.onclick = () => openFile(fileKey);

        const label = document.createElement('span');
        label.textContent = fileData.originalName || fileData.name;
        tab.appendChild(label);

        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-tab-btn';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = (e) => closeFile(e, fileKey);
        tab.appendChild(closeBtn);

        tabsContainer.appendChild(tab);
      });
    }

    function saveCurrentFile() {
      if (!currentFile || !editor) return;

      const model = editor.getModel();
      if (model) {
        files[currentFile].content = model.getValue();
        files[currentFile].updatedAt = new Date().toISOString();

        projectRef.child('updatedAt').set(new Date().toISOString());

        updateFirebaseFiles(() => {
            saveFileBtn.disabled = true;
            saveFileBtn.textContent = 'Salvo!';
            setTimeout(() => { saveFileBtn.textContent = 'üíæ Salvar' }, 1500);
        });
      }
    }

    function updateFirebaseFiles(callback) {
      projectRef.child('files').set(files, (error) => {
          if (error) {
              alert('Falha ao salvar o arquivo.');
              console.error(error);
          } else if (callback) {
              callback();
          }
      });
    }

    function updateProjectName() {
        const newName = projectNameInput.value.trim();
        if (!newName) {
            alert('O nome do projeto n√£o pode ser vazio.');
            projectRef.child('name').once('value', s => projectNameInput.value = s.val());
            return;
        }
        projectRef.child('name').set(newName);
        projectRef.child('updatedAt').set(new Date().toISOString());
   