<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizar Projeto</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      flex-direction: column;
      z-index: 1000;
    }

    #file-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: none;
      flex-direction: column;
      z-index: 1001;
    }

    #file-header {
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #file-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #file-content img,
    #file-content video {
      max-width: 100%;
      max-height: 100%;
    }

    #close-file {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: red;
      text-align: center;
      padding: 20px;
    }

    /* Estilos para lista de arquivos */
    #file-list {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      padding: 20px;
      overflow-y: auto;
      z-index: 1002;
    }

    .file-item {
      padding: 15px;
      margin: 10px 0;
      background: #f5f5f5;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: background 0.3s;
    }

    .file-item:hover {
      background: #e9e9e9;
    }

    .file-name {
      font-weight: bold;
      color: #333;
    }

    .file-type {
      color: #666;
      font-size: 12px;
      margin-left: 10px;
    }

    .file-icon {
      margin-right: 10px;
      font-size: 16px;
    }

    .back-button {
      background: #4361ee;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .url-badge {
      background: #4caf50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 10px;
    }

    /* Estilos para o executor de API */
    #api-executor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 1003;
      flex-direction: column;
    }

    #api-header {
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #api-controls {
      padding: 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #api-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #api-editor {
      flex: 1;
      border: none;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: none;
      outline: none;
    }

    #api-output {
      flex: 1;
      border-top: 1px solid #ddd;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      background: #f8f8f8;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .api-button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    #run-api {
      background: #4caf50;
      color: white;
    }

    #clear-api {
      background: #ff9800;
      color: white;
    }

    #close-api {
      background: #ff4444;
      color: white;
    }

    .api-status {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-ready {
      background: #e7f3ff;
      color: #1976d2;
    }

    .status-running {
      background: #fff8e1;
      color: #ff8f00;
    }

    .status-success {
      background: #e8f5e9;
      color: #388e3c;
    }

    .status-error {
      background: #ffebee;
      color: #d32f2f;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader"></div>
    <div>Carregando projeto...</div>
  </div>

  <div id="file-list">
    <button class="back-button" onclick="showProject()">‚Üê Voltar ao Projeto</button>
    <h2>Arquivos do Projeto</h2>
    <div id="file-list-content"></div>
  </div>

  <div id="file-viewer">
    <div id="file-header">
      <span id="file-title">Visualizando Arquivo</span>
      <button id="close-file">Fechar</button>
    </div>
    <div id="file-content"></div>
  </div>

  <div id="api-executor">
    <div id="api-header">
      <span>Executor de API</span>
      <button id="close-api">Fechar</button>
    </div>
    <div id="api-controls">
      <button id="run-api" class="api-button">Executar API</button>
      <button id="clear-api" class="api-button">Limpar</button>
      <span id="api-status" class="api-status status-ready">Pronto</span>
    </div>
    <div id="api-content">
      <textarea id="api-editor" placeholder="Cole seu c√≥digo JavaScript aqui para testar APIs..."></textarea>
      <div id="api-output">// Resultados aparecer√£o aqui...</div>
    </div>
  </div>

  <iframe id="preview-frame" style="display: none;"></iframe>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:1ac651348e624f6be41b32",
      measurementId: "G-7E1VWN07GM"
    };

    // Verifica se j√° existe uma app do Firebase para evitar erro de duplica√ß√£o
    let app;
    try {
      app = firebase.initializeApp(firebaseConfig);
    } catch (error) {
      // Se j√° foi inicializada, usa a existente
      app = firebase.app();
    }

    const db = firebase.database();
    const auth = firebase.auth();

    const loadingEl = document.getElementById('loading');
    const previewFrame = document.getElementById('preview-frame');
    const fileViewer = document.getElementById('file-viewer');
    const fileContent = document.getElementById('file-content');
    const fileTitle = document.getElementById('file-title');
    const closeFileBtn = document.getElementById('close-file');
    const fileList = document.getElementById('file-list');
    const fileListContent = document.getElementById('file-list-content');
    
    // Elementos do executor de API
    const apiExecutor = document.getElementById('api-executor');
    const apiEditor = document.getElementById('api-editor');
    const apiOutput = document.getElementById('api-output');
    const runApiBtn = document.getElementById('run-api');
    const clearApiBtn = document.getElementById('clear-api');
    const closeApiBtn = document.getElementById('close-api');
    const apiStatus = document.getElementById('api-status');

    let currentProjectData = null;
    let currentSubdomain = null;
    let currentProjectId = null;
    let currentFileName = null;
    let substituicaoAplicada = false;
    let projetoCarregado = false;

    // FUN√á√ÉO DE SUBSTITUI√á√ÉO AUTOM√ÅTICA CORRIGIDA
    function substituirArquivosPorURLs(htmlContent, projectFiles) {
      console.log('üîç Iniciando substitui√ß√£o autom√°tica de arquivos...');

      if (!projectFiles || !htmlContent || substituicaoAplicada) {
        console.log('‚ùå Substitui√ß√£o j√° aplicada ou dados insuficientes');
        return htmlContent;
      }

      let novoHTML = htmlContent;

      // Fun√ß√£o auxiliar para encontrar arquivo
      function encontrarArquivo(nomeArquivo) {
        if (!projectFiles) return null;

        // Remove caminhos e par√¢metros, fica s√≥ com o nome do arquivo
        const nomeLimpo = nomeArquivo.split('/').pop().split('?')[0];

        console.log(`üîé Procurando: "${nomeArquivo}" -> "${nomeLimpo}"`);

        // Procura em todos os arquivos
        for (const fileKey in projectFiles) {
          const file = projectFiles[fileKey];

          // Verifica por diferentes nomes (case insensitive)
          if (file.originalName?.toLowerCase() === nomeLimpo.toLowerCase() || 
              file.name?.toLowerCase() === nomeLimpo.toLowerCase() ||
              file.originalName?.toLowerCase() === nomeArquivo.toLowerCase() ||
              file.name?.toLowerCase() === nomeArquivo.toLowerCase()) {
            console.log(`‚úÖ Encontrado: ${file.originalName || file.name}`);
            return file;
          }
        }

        console.log(`‚ùå N√£o encontrado: ${nomeLimpo}`);
        return null;
      }

      // Substitui todos os src="arquivo.ext" por src="URL_COMPLETA"
      const srcRegex = /src=["']([^"']+)["']/g;
      novoHTML = novoHTML.replace(srcRegex, (match, src) => {
        // Ignora URLs que j√° s√£o completas
        if (src.startsWith('http') || src.startsWith('data:') || src.startsWith('//') || src.includes('://')) {
          return match;
        }

        const arquivo = encontrarArquivo(src);
        if (arquivo && (arquivo.directUrl || arquivo.url)) {
          const novaUrl = arquivo.directUrl || arquivo.url;
          console.log(`üîÑ Substituindo: "${src}" -> "${novaUrl}"`);
          return `src="${novaUrl}"`;
        }
        return match;
      });

      // Substitui todos os href="arquivo.ext" por href="URL_COMPLETA" (apenas para arquivos de m√≠dia)
      const hrefRegex = /href=["']([^"']+)["']/g;
      novoHTML = novoHTML.replace(hrefRegex, (match, href) => {
        // Ignora URLs externas, √¢ncoras, etc.
        if (href.startsWith('http') || href.startsWith('#') || href.startsWith('mailto:') || 
            href.startsWith('tel:') || href.includes('://') || href.endsWith('.html')) {
          return match;
        }

        // S√≥ substitui se for arquivo de m√≠dia
        const extensoesMidia = ['.mp3', '.mp4', '.jpg', '.jpeg', '.png', '.gif', '.pdf', '.wav', '.ogg'];
        const temExtensaoMidia = extensoesMidia.some(ext => href.toLowerCase().endsWith(ext));

        if (temExtensaoMidia) {
          const arquivo = encontrarArquivo(href);
          if (arquivo && (arquivo.directUrl || arquivo.url)) {
            const novaUrl = arquivo.directUrl || arquivo.url;
            console.log(`üîó Substituindo link: "${href}" -> "${novaUrl}"`);
            return `href="${novaUrl}"`;
          }
        }
        return match;
      });

      // SISTEMA DE BOT√ïES PARA ABRIR ARQUIVOS
      const buttonRegex = /<button[^>]*data-open-file=["']([^"']+)["'][^>]*>([^<]*)<\/button>/gi;
      novoHTML = novoHTML.replace(buttonRegex, (match, fileName, buttonText) => {
        console.log(`üéØ Bot√£o encontrado: "${buttonText}" -> arquivo: "${fileName}"`);

        const arquivo = encontrarArquivo(fileName);
        if (arquivo && (arquivo.directUrl || arquivo.url)) {
          const url = arquivo.directUrl || arquivo.url;
          console.log(`üîó Criando bot√£o com URL: ${url}`);

          // Cria um bot√£o que abre o arquivo em nova aba
          return `<button onclick="window.open('${url}', '_blank')" style="cursor: pointer; padding: 10px 15px; background: #4361ee; color: white; border: none; border-radius: 5px;">${buttonText}</button>`;
        } else {
          // Se n√£o encontrou o arquivo, mant√©m o bot√£o original
          console.log(`‚ùå Arquivo n√£o encontrado para bot√£o: ${fileName}`);
          return match;
        }
      });

      // SISTEMA DE LINKS ESPECIAIS - Abre arquivos dentro do visualizador
      const linkRegex = /<a[^>]*href=["']#open-file\/([^"']+)["'][^>]*>([^<]*)<\/a>/gi;
      novoHTML = novoHTML.replace(linkRegex, (match, fileName, linkText) => {
        console.log(`üîó Link especial encontrado: "${linkText}" -> arquivo: "${fileName}"`);

        const arquivo = encontrarArquivo(fileName);
        if (arquivo) {
          console.log(`üìÅ Arquivo encontrado para link especial: ${fileName}`);

          // Cria um link que chama a fun√ß√£o global para abrir o arquivo
          return `<a href="javascript:void(0)" onclick="window.abrirArquivoNoVisualizador('${fileName}')" style="cursor: pointer; color: #4361ee; text-decoration: underline;">${linkText}</a>`;
        } else {
          console.log(`‚ùå Arquivo n√£o encontrado para link especial: ${fileName}`);
          return match;
        }
      });

      // ADICIONAR BOT√ÉO DE EXECUTAR API
      if (novoHTML.includes('<body>')) {
        const apiButton = `
          <div style="position: fixed; top: 10px; right: 10px; z-index: 9999;">
            <button onclick="window.showApiExecutor()" style="background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">
              Executar API
            </button>
          </div>
        `;
        novoHTML = novoHTML.replace('<body>', '<body>' + apiButton);
      }

      substituicaoAplicada = true;
      console.log('‚úÖ Substitui√ß√£o conclu√≠da');
      return novoHTML;
    }

    // FUN√á√ÉO GLOBAL PARA ABRIR ARQUIVOS NO VISUALIZADOR
    function abrirArquivoNoVisualizador(fileName) {
      console.log(`üöÄ Abrindo arquivo no visualizador: ${fileName}`);
      if (currentProjectData && currentProjectData.files) {
        openSpecificFile(fileName);
      } else {
        alert('Arquivo n√£o encontrado no projeto atual');
      }
    }

    // FUN√á√ÉO PARA CRIAR URL DE ACESSO DIRETO - CORRIGIDA
    function criarUrlParaArquivo(fileName) {
      const urlAtual = window.location.href;
      const urlBase = urlAtual.split('/view.html')[0]; // Pega a base at√© view.html

      // SEMPRE usa min√∫sculas para dom√≠nios
      const dominioNormalizado = currentSubdomain ? currentSubdomain.toLowerCase() : null;
      const projectIdNormalizado = currentProjectId ? currentProjectId.toLowerCase() : null;

      if (dominioNormalizado) {
        if (fileName) {
          return {
            novaForma: `${urlBase}/view.html/${dominioNormalizado}/${fileName}`,
            formaAntiga: `${urlBase}/view.html?l=${dominioNormalizado}/${fileName}`
          };
        } else {
          return {
            novaForma: `${urlBase}/view.html/${dominioNormalizado}`,
            formaAntiga: `${urlBase}/view.html?l=${dominioNormalizado}`
          };
        }
      } else if (projectIdNormalizado) {
        if (fileName) {
          return {
            novaForma: `${urlBase}/view.html/${projectIdNormalizado}/${fileName}`,
            formaAntiga: `${urlBase}/view.html?projectId=${projectIdNormalizado}/${fileName}`
          };
        } else {
          return {
            novaForma: `${urlBase}/view.html/${projectIdNormalizado}`,
            formaAntiga: `${urlBase}/view.html?projectId=${projectIdNormalizado}`
          };
        }
      } else {
        return { novaForma: urlAtual, formaAntiga: urlAtual };
      }
    }

    // FUN√á√ïES DO EXECUTOR DE API
    function showApiExecutor() {
      apiExecutor.style.display = 'flex';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileViewer.style.display = 'none';
      fileList.style.display = 'none';
      
      // Foca no editor
      setTimeout(() => {
        apiEditor.focus();
      }, 100);
    }

    function closeApiExecutor() {
      apiExecutor.style.display = 'none';
      showProject(); // Volta para o projeto principal
    }

    function runApiCode() {
      const code = apiEditor.value.trim();
      
      if (!code) {
        apiOutput.textContent = '// Nenhum c√≥digo para executar.';
        return;
      }
      
      // Atualiza status
      apiStatus.textContent = 'Executando...';
      apiStatus.className = 'api-status status-running';
      
      // Limpa output anterior
      apiOutput.textContent = '';
      
      try {
        // Cria um contexto seguro para execu√ß√£o
        const logs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        // Captura logs
        console.log = function(...args) {
          logs.push(args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
          ).join(' '));
          originalConsoleLog.apply(console, args);
        };
        
        console.error = function(...args) {
          logs.push('ERRO: ' + args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
          ).join(' '));
          originalConsoleError.apply(console, args);
        };
        
        // Executa o c√≥digo
        const result = eval(code);
        
        // Restaura console original
        console.log = originalConsoleLog;
        console.error = originalConsoleError;
        
        // Mostra resultado
        let output = '';
        
        if (logs.length > 0) {
          output += logs.join('\n') + '\n\n';
        }
        
        if (result !== undefined) {
          output += 'Resultado: ' + 
            (typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result));
        } else {
          output += 'Execu√ß√£o conclu√≠da (sem retorno).';
        }
        
        apiOutput.textContent = output;
        apiStatus.textContent = 'Sucesso';
        apiStatus.className = 'api-status status-success';
        
      } catch (error) {
        // Restaura console original em caso de erro
        console.log = originalConsoleLog;
        console.error = originalConsoleError;
        
        apiOutput.textContent = 'ERRO: ' + error.message;
        apiStatus.textContent = 'Erro';
        apiStatus.className = 'api-status status-error';
      }
    }

    function clearApiCode() {
      apiEditor.value = '';
      apiOutput.textContent = '// Resultados aparecer√£o aqui...';
      apiStatus.textContent = 'Pronto';
      apiStatus.className = 'api-status status-ready';
    }

    function showError(message) {
      loadingEl.innerHTML = `<div class="error">${message}</div>`;
    }

    function joinChunks(chunks) {
      return chunks ? chunks.join('') : '';
    }

    function findFileByName(files, fileName) {
      if (!files) return null;

      // Busca case insensitive
      const fileNameLower = fileName.toLowerCase();

      // Primeiro procura pelo nome original (case insensitive)
      for (const fileKey in files) {
        const file = files[fileKey];
        if (file.originalName && file.originalName.toLowerCase() === fileNameLower) {
          return file;
        }
      }

      // Depois procura pelo nome codificado (case insensitive)
      for (const fileKey in files) {
        const file = files[fileKey];
        if (file.name && file.name.toLowerCase() === fileNameLower) {
          return file;
        }
      }

      // Finalmente procura pela chave (case insensitive)
      for (const fileKey in files) {
        if (fileKey.toLowerCase() === fileNameLower) {
          return files[fileKey];
        }
      }

      return null;
    }

    function findMainFile(files) {
      if (!files) return null;

      const fileList = Object.values(files);

      // 1. Procura por index.html (case insensitive)
      let mainFile = fileList.find(f => 
        (f.originalName && f.originalName.toLowerCase() === 'index.html') || 
        (f.name && f.name.toLowerCase() === 'index.html')
      );

      // 2. Se n√£o encontrou, procura qualquer arquivo HTML
      if (!mainFile) {
        mainFile = fileList.find(f => 
          (f.originalName && f.originalName.toLowerCase().endsWith('.html')) ||
          (f.name && f.name.toLowerCase().endsWith('.html'))
        );
      }

      return mainFile;
    }

    function isUploadedFile(file) {
      return file && (file.directUrl || file.url);
    }

    function getFileIcon(fileName, fileType) {
      const extension = fileName.split('.').pop().toLowerCase();

      if (extension === 'html' || fileType === 'html') return 'üåê';
      if (extension === 'css' || fileType === 'css') return 'üé®';
      if (extension === 'js' || fileType === 'javascript') return '‚ö°';
      if (extension === 'json') return 'üìã';
      if (extension === 'txt') return 'üìÑ';
      if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) return 'üñºÔ∏è';
      if (['mp4', 'avi', 'mov', 'webm'].includes(extension)) return 'üé•';
      if (['mp3', 'wav', 'ogg'].includes(extension)) return 'üéµ';
      if (['pdf'].includes(extension)) return 'üìï';
      return 'üìÑ';
    }

    // ATUALIZADO PARA N√ÉO MODIFICAR A URL AUTOMATICAMENTE
    function updateUrl(fileName = null) {
      // N√ÉO atualiza mais a URL automaticamente para evitar problemas
      // A URL original fica como foi acessada
      console.log('üìù URL mantida como original para evitar problemas');
      currentFileName = fileName;
    }

    function showMediaFile(file, fileName) {
      const url = file.directUrl || file.url;
      const type = file.type || '';
      const extension = fileName.split('.').pop().toLowerCase();

      fileTitle.textContent = fileName || file.originalName || 'Arquivo';

      // Se for imagem, mostra diretamente
      if (type.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) {
        fileContent.innerHTML = `<img src="${url}" alt="${fileName}" style="max-width: 100%; max-height: 100%;">`;
      } 
      // Se for v√≠deo, mostra player
      else if (type.startsWith('video/') || ['mp4', 'avi', 'mov', 'webm'].includes(extension)) {
        fileContent.innerHTML = `
          <video controls autoplay style="max-width: 100%; max-height: 100%;">
            <source src="${url}" type="${type}">
            Seu navegador n√£o suporta v√≠deo.
          </video>
        `;
      } 
      // Se for √°udio, mostra player
      else if (type.startsWith('audio/') || ['mp3', 'wav', 'ogg'].includes(extension)) {
        fileContent.innerHTML = `
          <audio controls autoplay>
            <source src="${url}" type="${type}">
            Seu navegador n√£o suporta √°udio.
          </audio>
        `;
      }
      // Se for PDF, mostra em iframe
      else if (type.includes('pdf') || extension === 'pdf') {
        fileContent.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      }
      // Para outros tipos (URL externa), mostra em iframe
      else {
        fileContent.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      }

      fileViewer.style.display = 'flex';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileList.style.display = 'none';

      // Atualiza URL (agora n√£o modifica mais)
      updateUrl(fileName);
    }

    function showTextFile(content, fileName, type = 'html') {
      if (type === 'html') {
        // Reseta a flag de substitui√ß√£o para aplicar novamente
        substituicaoAplicada = false;

        // APLICA A SUBSTITUI√á√ÉO AUTOM√ÅTICA AQUI
        console.log('üéØ Aplicando substitui√ß√£o autom√°tica...');
        const htmlComSubstituicao = substituirArquivosPorURLs(content, currentProjectData.files);

        previewFrame.srcdoc = htmlComSubstituicao;
        previewFrame.style.display = 'block';
        loadingEl.style.display = 'none';
        fileViewer.style.display = 'none';
        fileList.style.display = 'none';
        document.title = fileName;
      } else {
        fileTitle.textContent = fileName;

        // Formata√ß√£o de c√≥digo
        if (type === 'css' || type === 'javascript' || type === 'json') {
          content = `<pre style="font-family: 'Courier New', monospace; background: #f8f8f8; padding: 20px; border-radius: 5px; overflow: auto; margin: 0;">${escapeHtml(content)}</pre>`;
        } else {
          content = `<pre style="font-family: Arial, sans-serif; padding: 20px; margin: 0;">${escapeHtml(content)}</pre>`;
        }

        fileContent.innerHTML = content;
        fileViewer.style.display = 'flex';
        loadingEl.style.display = 'none';
        previewFrame.style.display = 'none';
        fileList.style.display = 'none';
      }

      // Atualiza URL (agora n√£o modifica mais)
      updateUrl(fileName);
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showFileList() {
      if (!currentProjectData || !currentProjectData.files) {
        showError('Nenhum arquivo encontrado no projeto.');
        return;
      }

      fileListContent.innerHTML = '';
      const files = currentProjectData.files;

      // Adiciona item para Executar API
      const apiItem = document.createElement('div');
      apiItem.className = 'file-item';
      apiItem.onclick = showApiExecutor;
      apiItem.innerHTML = `
        <div>
          <span class="file-icon">üöÄ</span>
          <span class="file-name">Executar API</span>
          <div class="file-type">Teste qualquer API com JavaScript</div>
        </div>
      `;
      fileListContent.appendChild(apiItem);

      for (const fileKey in files) {
        const file = files[fileKey];
        const fileName = file.originalName || file.name || fileKey;
        const fileType = file.language || (fileName.split('.').pop() || 'arquivo');
        const fileIcon = getFileIcon(fileName, fileType);
        const isUrlFile = isUploadedFile(file);

        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.onclick = () => openSpecificFile(fileName);

        fileItem.innerHTML = `
          <div>
            <span class="file-icon">${fileIcon}</span>
            <span class="file-name">${fileName}</span>
            ${isUrlFile ? '<span class="url-badge">URL</span>' : ''}
            <div class="file-type">Tipo: ${fileType}</div>
          </div>
        `;

        fileListContent.appendChild(fileItem);
      }

      fileList.style.display = 'block';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileViewer.style.display = 'none';

      // Atualiza URL para raiz (agora n√£o modifica mais)
      updateUrl(null);
    }

    function showProject() {
      if (!currentProjectData) return;

      const mainFile = findMainFile(currentProjectData.files);
      if (mainFile) {
        openSpecificFile(mainFile.originalName || mainFile.name);
      } else {
        showFileList();
      }
    }

    function openSpecificFile(fileName) {
      if (!currentProjectData || !currentProjectData.files) return;

      const file = findFileByName(currentProjectData.files, fileName);
      if (!file) {
        showError(`Arquivo "${fileName}" n√£o encontrado.`);
        return;
      }

      if (isUploadedFile(file)) {
        showMediaFile(file, fileName);
      } else {
        const content = joinChunks(file.chunks) || file.content || '';
        const fileType = file.language || fileName.split('.').pop() || 'text';
        showTextFile(content, fileName, fileType);
      }
    }

    function renderProject(projectData) {
      if (!projectData || !projectData.files) {
        showError('Projeto sem arquivos ou dados inv√°lidos.');
        return;
      }

      currentProjectData = projectData;

      const mainFile = findMainFile(projectData.files);
      if (mainFile) {
        // Se tem index.html ou arquivo HTML principal, abre automaticamente
        openSpecificFile(mainFile.originalName || mainFile.name);
      } else {
        // Se n√£o tem arquivo principal, mostra lista de arquivos
        showFileList();
      }

      // Atualiza t√≠tulo da p√°gina
      document.title = projectData.name || 'Visualiza√ß√£o do Projeto';
    }

    // FUN√á√ÉO PARA BUSCAR PROJETO POR SUBDOM√çNIO
    async function getProjectBySubdomain(subdomain) {
      try {
        // SEMPRE usa min√∫sculas para buscar no Firebase
        const dominioLower = subdomain.toLowerCase();
        const domainRef = db.ref('domains/' + dominioLower);
        const snapshot = await domainRef.once('value');
        const domainData = snapshot.val();

        if (!domainData) {
          return null;
        }

        return domainData.projectId;
      } catch (error) {
        console.error('Erro ao buscar subdom√≠nio:', error);
        return null;
      }
    }

    // FUN√á√ÉO PARA PROCESSAR PAR√ÇMETROS DA URL - CORRIGIDA
    function parseUrlParameters() {
      const path = window.location.pathname;
      const urlParams = new URLSearchParams(window.location.search);
      const subdomain = urlParams.get('l');
      const projectId = urlParams.get('projectId');

      console.log('üìç Path atual:', path);
      console.log('üìã Par√¢metros URL:', { subdomain, projectId });

      // PRIMEIRO: Verifica se tem par√¢metros na query string (?l= ou ?projectId=)
      if (subdomain) {
        console.log('üìù Usando par√¢metro ?l=');
        let fileName = null;
        if (subdomain.includes('/')) {
          const parts = subdomain.split('/');
          const cleanSubdomain = parts[0];
          fileName = parts.slice(1).join('/');
          return { type: 'subdomain', projectId: cleanSubdomain, fileName };
        } else {
          return { type: 'subdomain', projectId: subdomain, fileName: null };
        }
      } else if (projectId) {
        console.log('üìù Usando par√¢metro ?projectId=');
        let fileName = null;
        if (projectId.includes('/')) {
          const parts = projectId.split('/');
          const cleanProjectId = parts[0];
          fileName = parts.slice(1).join('/');
          return { type: 'projectId', projectId: cleanProjectId, fileName };
        } else {
          return { type: 'projectId', projectId: projectId, fileName: null };
        }
      }

      // SEGUNDO: Verifica se o path segue o padr√£o /view.html/dom√≠nio/arquivo (nova forma)
      if (path.includes('/view.html/')) {
        console.log('üìù Usando nova forma (view.html/)');
        const parts = path.split('/view.html/');
        if (parts.length > 1) {
          const restante = parts[1];
          const subParts = restante.split('/');

          if (subParts.length >= 1) {
            const dominioOuProjectId = subParts[0];
            const fileName = subParts.length > 1 ? subParts.slice(1).join('/') : null;

            console.log('üìã Par√¢metros extra√≠dos:', { dominioOuProjectId, fileName });

            // Verifica se √© subdom√≠nio (normalmente letras e n√∫meros) ou projectId (normalmente come√ßa com -)
            if (dominioOuProjectId.startsWith('-')) {
              return { type: 'projectId', projectId: dominioOuProjectId, fileName };
            } else {
              return { type: 'subdomain', projectId: dominioOuProjectId, fileName };
            }
          }
        }
      }

      console.log('‚ùå Nenhum projeto especificado');
      return null;
    }

    async function loadProject() {
      // Evita carregar m√∫ltiplas vezes
      if (projetoCarregado) {
        console.log('‚úÖ Projeto j√° carregado, ignorando nova tentativa');
        return;
      }

      const params = parseUrlParameters();

      if (!params) {
        showError('Nenhum projeto especificado. Use: /view.html/dominio ou /view.html?l=dominio');
        return;
      }

      try {
        loadingEl.style.display = 'flex';

        const user = await new Promise((resolve) => {
          const unsubscribe = auth.onAuthStateChanged(user => {
            unsubscribe();
            resolve(user);
          });
        });

        if (!user) {
          showError('Usu√°rio n√£o autenticado. Redirecionando...');
          setTimeout(() => window.location.href = 'auth.html', 2000);
          return;
        }

        let finalProjectId = params.projectId;

        // Se for subdom√≠nio, busca o projectId real (SEMPRE em min√∫sculas)
        if (params.type === 'subdomain') {
          // Normaliza para min√∫sculas
          const dominioNormalizado = params.projectId.toLowerCase();
          finalProjectId = await getProjectBySubdomain(dominioNormalizado);
          if (!finalProjectId) {
            showError('Subdom√≠nio n√£o encontrado.');
            return;
          }
          currentSubdomain = dominioNormalizado; // Armazena em min√∫sculas
        } else {
          currentProjectId = params.projectId;
        }

        currentProjectId = finalProjectId;

        // Busca projeto
        let projectRef = db.ref('projects/' + user.uid + '/' + finalProjectId);
        let snapshot = await projectRef.once('value');
        let projectData = snapshot.val();

        if (!projectData) {
          projectRef = db.ref('projects/' + finalProjectId);
          snapshot = await projectRef.once('value');
          projectData = snapshot.val();
        }

        if (!projectData) {
          showError('Projeto n√£o encontrado.');
          return;
        }

        currentProjectData = projectData;
        projetoCarregado = true;

        // Se tem arquivo espec√≠fico na URL
        if (params.fileName) {
          openSpecificFile(params.fileName);
        } else {
          // Mostra projeto completo (index.html ou lista)
          renderProject(projectData);
        }

      } catch (error) {
        console.error('Erro ao carregar projeto:', error);
        showError('Erro ao carregar projeto: ' + error.message);
      }
    }

    // Event Listeners
    closeFileBtn.addEventListener('click', function() {
      fileViewer.style.display = 'none';
      fileContent.innerHTML = '';
      showProject(); // Volta para o projeto principal
    });

    closeApiBtn.addEventListener('click', closeApiExecutor);
    runApiBtn.addEventListener('click', runApiCode);
    clearApiBtn.addEventListener('click', clearApiCode);

    // Previne recarregamento duplo
    let carregamentoIniciado = false;

    document.addEventListener('DOMContentLoaded', function() {
      if (!carregamentoIniciado) {
        carregamentoIniciado = true;
        console.log('üöÄ Iniciando carregamento do projeto...');
        loadProject();
      }
    });

    // FUN√á√ïES GLOBAIS PARA ACESSO EXTERNO
    window.showFileList = showFileList;
    window.showProject = showProject;
    window.substituirArquivosPorURLs = substituirArquivosPorURLs;
    window.abrirArquivoNoVisualizador = abrirArquivoNoVisualizador;
    window.criarUrlParaArquivo = criarUrlParaArquivo;
    window.openSpecificFile = openSpecificFile;
    window.showApiExecutor = showApiExecutor;
    window.runApiCode = runApiCode;
  </script>
</body>
</html>
