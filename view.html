<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizar Projeto</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      flex-direction: column;
      z-index: 1000;
    }

    #file-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: none;
      flex-direction: column;
      z-index: 1001;
    }

    #file-header {
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #file-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #file-content img,
    #file-content video {
      max-width: 100%;
      max-height: 100%;
    }

    #close-file {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: red;
      text-align: center;
      padding: 20px;
    }

    /* Estilos para lista de arquivos */
    #file-list {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      padding: 20px;
      overflow-y: auto;
      z-index: 1002;
    }

    .file-item {
      padding: 15px;
      margin: 10px 0;
      background: #f5f5f5;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: background 0.3s;
    }

    .file-item:hover {
      background: #e9e9e9;
    }

    .file-name {
      font-weight: bold;
      color: #333;
    }

    .file-type {
      color: #666;
      font-size: 12px;
      margin-left: 10px;
    }

    .file-icon {
      margin-right: 10px;
      font-size: 16px;
    }

    .back-button {
      background: #4361ee;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .url-badge {
      background: #4caf50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader"></div>
    <div>Carregando projeto...</div>
  </div>

  <div id="file-list">
    <button class="back-button" onclick="showProject()">‚Üê Voltar ao Projeto</button>
    <h2>Arquivos do Projeto</h2>
    <div id="file-list-content"></div>
  </div>

  <div id="file-viewer">
    <div id="file-header">
      <span id="file-title">Visualizando Arquivo</span>
      <button id="close-file">Fechar</button>
    </div>
    <div id="file-content"></div>
  </div>

  <iframe id="preview-frame" style="display: none;"></iframe>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:1ac651348e624f6be41b32",
      measurementId: "G-7E1VWN07GM"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const loadingEl = document.getElementById('loading');
    const previewFrame = document.getElementById('preview-frame');
    const fileViewer = document.getElementById('file-viewer');
    const fileContent = document.getElementById('file-content');
    const fileTitle = document.getElementById('file-title');
    const closeFileBtn = document.getElementById('close-file');
    const fileList = document.getElementById('file-list');
    const fileListContent = document.getElementById('file-list-content');

    let currentProjectData = null;
    let currentSubdomain = null;
    let currentProjectId = null;
    let currentFileName = null;

    // FUN√á√ÉO DE SUBSTITUI√á√ÉO AUTOM√ÅTICA - VERS√ÉO SIMPLIFICADA E FUNCIONAL
    function substituirArquivosPorURLs(htmlContent, projectFiles) {
      console.log('üîç Iniciando substitui√ß√£o autom√°tica de arquivos...');
      
      if (!projectFiles || !htmlContent) {
        console.log('‚ùå Dados insuficientes para substitui√ß√£o');
        return htmlContent;
      }

      let novoHTML = htmlContent;

      // Fun√ß√£o auxiliar para encontrar arquivo
      function encontrarArquivo(nomeArquivo) {
        if (!projectFiles) return null;

        // Remove caminhos e par√¢metros, fica s√≥ com o nome do arquivo
        const nomeLimpo = nomeArquivo.split('/').pop().split('?')[0];
        
        console.log(`üîé Procurando: "${nomeArquivo}" -> "${nomeLimpo}"`);

        // Procura em todos os arquivos
        for (const fileKey in projectFiles) {
          const file = projectFiles[fileKey];
          
          // Verifica por diferentes nomes
          if (file.originalName === nomeLimpo || 
              file.name === nomeLimpo ||
              file.originalName === nomeArquivo ||
              file.name === nomeArquivo) {
            console.log(`‚úÖ Encontrado: ${file.originalName || file.name}`);
            return file;
          }
        }
        
        console.log(`‚ùå N√£o encontrado: ${nomeLimpo}`);
        return null;
      }

      // Substitui todos os src="arquivo.ext" por src="URL_COMPLETA"
      const srcRegex = /src=["']([^"']+)["']/g;
      novoHTML = novoHTML.replace(srcRegex, (match, src) => {
        // Ignora URLs que j√° s√£o completas
        if (src.startsWith('http') || src.startsWith('data:') || src.startsWith('//') || src.includes('://')) {
          return match;
        }
        
        const arquivo = encontrarArquivo(src);
        if (arquivo && (arquivo.directUrl || arquivo.url)) {
          const novaUrl = arquivo.directUrl || arquivo.url;
          console.log(`üîÑ Substituindo: "${src}" -> "${novaUrl}"`);
          return `src="${novaUrl}"`;
        }
        return match;
      });

      // Substitui todos os href="arquivo.ext" por href="URL_COMPLETA" (apenas para arquivos de m√≠dia)
      const hrefRegex = /href=["']([^"']+)["']/g;
      novoHTML = novoHTML.replace(hrefRegex, (match, href) => {
        // Ignora URLs externas, √¢ncoras, etc.
        if (href.startsWith('http') || href.startsWith('#') || href.startsWith('mailto:') || 
            href.startsWith('tel:') || href.includes('://') || href.endsWith('.html')) {
          return match;
        }
        
        // S√≥ substitui se for arquivo de m√≠dia
        const extensoesMidia = ['.mp3', '.mp4', '.jpg', '.jpeg', '.png', '.gif', '.pdf', '.wav', '.ogg'];
        const temExtensaoMidia = extensoesMidia.some(ext => href.toLowerCase().endsWith(ext));
        
        if (temExtensaoMidia) {
          const arquivo = encontrarArquivo(href);
          if (arquivo && (arquivo.directUrl || arquivo.url)) {
            const novaUrl = arquivo.directUrl || arquivo.url;
            console.log(`üîó Substituindo link: "${href}" -> "${novaUrl}"`);
            return `href="${novaUrl}"`;
          }
        }
        return match;
      });

      console.log('‚úÖ Substitui√ß√£o conclu√≠da');
      return novoHTML;
    }

    function showError(message) {
      loadingEl.innerHTML = `<div class="error">${message}</div>`;
    }

    function joinChunks(chunks) {
      return chunks ? chunks.join('') : '';
    }

    function findFileByName(files, fileName) {
      if (!files) return null;

      // Primeiro procura pelo nome original
      for (const fileKey in files) {
        const file = files[fileKey];
        if (file.originalName === fileName) {
          return file;
        }
      }

      // Depois procura pelo nome codificado
      for (const fileKey in files) {
        const file = files[fileKey];
        if (file.name === fileName) {
          return file;
        }
      }

      // Finalmente procura pela chave
      if (files[fileName]) {
        return files[fileName];
      }

      return null;
    }

    function findMainFile(files) {
      if (!files) return null;

      const fileList = Object.values(files);

      // 1. Procura por index.html
      let mainFile = fileList.find(f => 
        f.originalName === 'index.html' || f.name === 'index.html'
      );

      // 2. Se n√£o encontrou, procura qualquer arquivo HTML
      if (!mainFile) {
        mainFile = fileList.find(f => 
          (f.originalName && f.originalName.endsWith('.html')) ||
          (f.name && f.name.endsWith('.html'))
        );
      }

      return mainFile;
    }

    function isUploadedFile(file) {
      return file && (file.directUrl || file.url);
    }

    function getFileIcon(fileName, fileType) {
      const extension = fileName.split('.').pop().toLowerCase();

      if (extension === 'html' || fileType === 'html') return 'üåê';
      if (extension === 'css' || fileType === 'css') return 'üé®';
      if (extension === 'js' || fileType === 'javascript') return '‚ö°';
      if (extension === 'json') return 'üìã';
      if (extension === 'txt') return 'üìÑ';
      if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) return 'üñºÔ∏è';
      if (['mp4', 'avi', 'mov', 'webm'].includes(extension)) return 'üé•';
      if (['mp3', 'wav', 'ogg'].includes(extension)) return 'üéµ';
      if (['pdf'].includes(extension)) return 'üìï';
      return 'üìÑ';
    }

    function updateUrl(fileName = null) {
      const urlParams = new URLSearchParams(window.location.search);
      const subdomain = urlParams.get('l');
      const projectId = urlParams.get('projectId');

      let newUrl = window.location.pathname + '?';

      if (subdomain) {
        if (fileName) {
          newUrl += `l=${subdomain}/${fileName}`;
        } else {
          newUrl += `l=${subdomain}`;
        }
      } else if (projectId) {
        // Remove qualquer arquivo atual do projectId
        const cleanProjectId = projectId.split('/')[0];
        if (fileName) {
          newUrl += `projectId=${cleanProjectId}/${fileName}`;
        } else {
          newUrl += `projectId=${cleanProjectId}`;
        }
      }

      // Atualiza URL sem recarregar a p√°gina
      window.history.replaceState({}, '', newUrl);
      currentFileName = fileName;
    }

    function showMediaFile(file, fileName) {
      const url = file.directUrl || file.url;
      const type = file.type || '';
      const extension = fileName.split('.').pop().toLowerCase();

      fileTitle.textContent = fileName || file.originalName || 'Arquivo';

      // Se for imagem, mostra diretamente
      if (type.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) {
        fileContent.innerHTML = `<img src="${url}" alt="${fileName}" style="max-width: 100%; max-height: 100%;">`;
      } 
      // Se for v√≠deo, mostra player
      else if (type.startsWith('video/') || ['mp4', 'avi', 'mov', 'webm'].includes(extension)) {
        fileContent.innerHTML = `
          <video controls autoplay style="max-width: 100%; max-height: 100%;">
            <source src="${url}" type="${type}">
            Seu navegador n√£o suporta v√≠deo.
          </video>
        `;
      } 
      // Se for √°udio, mostra player
      else if (type.startsWith('audio/') || ['mp3', 'wav', 'ogg'].includes(extension)) {
        fileContent.innerHTML = `
          <audio controls autoplay>
            <source src="${url}" type="${type}">
            Seu navegador n√£o suporta √°udio.
          </audio>
        `;
      }
      // Se for PDF, mostra em iframe
      else if (type.includes('pdf') || extension === 'pdf') {
        fileContent.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      }
      // Para outros tipos (URL externa), mostra em iframe
      else {
        fileContent.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      }

      fileViewer.style.display = 'flex';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileList.style.display = 'none';

      // Atualiza URL
      updateUrl(fileName);
    }

    function showTextFile(content, fileName, type = 'html') {
      if (type === 'html') {
        // APLICA A SUBSTITUI√á√ÉO AUTOM√ÅTICA AQUI
        console.log('üéØ Aplicando substitui√ß√£o autom√°tica...');
        const htmlComSubstituicao = substituirArquivosPorURLs(content, currentProjectData.files);
        
        previewFrame.srcdoc = htmlComSubstituicao;
        previewFrame.style.display = 'block';
        loadingEl.style.display = 'none';
        fileViewer.style.display = 'none';
        fileList.style.display = 'none';
        document.title = fileName;
      } else {
        fileTitle.textContent = fileName;

        // Formata√ß√£o de c√≥digo
        if (type === 'css' || type === 'javascript' || type === 'json') {
          content = `<pre style="font-family: 'Courier New', monospace; background: #f8f8f8; padding: 20px; border-radius: 5px; overflow: auto; margin: 0;">${escapeHtml(content)}</pre>`;
        } else {
          content = `<pre style="font-family: Arial, sans-serif; padding: 20px; margin: 0;">${escapeHtml(content)}</pre>`;
        }

        fileContent.innerHTML = content;
        fileViewer.style.display = 'flex';
        loadingEl.style.display = 'none';
        previewFrame.style.display = 'none';
        fileList.style.display = 'none';
      }

      // Atualiza URL
      updateUrl(fileName);
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showFileList() {
      if (!currentProjectData || !currentProjectData.files) {
        showError('Nenhum arquivo encontrado no projeto.');
        return;
      }

      fileListContent.innerHTML = '';
      const files = currentProjectData.files;

      for (const fileKey in files) {
        const file = files[fileKey];
        const fileName = file.originalName || file.name || fileKey;
        const fileType = file.language || (fileName.split('.').pop() || 'arquivo');
        const fileIcon = getFileIcon(fileName, fileType);
        const isUrlFile = isUploadedFile(file);

        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.onclick = () => openSpecificFile(fileName);

        fileItem.innerHTML = `
          <div>
            <span class="file-icon">${fileIcon}</span>
            <span class="file-name">${fileName}</span>
            ${isUrlFile ? '<span class="url-badge">URL</span>' : ''}
            <div class="file-type">Tipo: ${fileType}</div>
          </div>
        `;

        fileListContent.appendChild(fileItem);
      }

      fileList.style.display = 'block';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileViewer.style.display = 'none';

      // Atualiza URL para raiz
      updateUrl(null);
    }

    function showProject() {
      if (!currentProjectData) return;

      const mainFile = findMainFile(currentProjectData.files);
      if (mainFile) {
        openSpecificFile(mainFile.originalName || mainFile.name);
      } else {
        showFileList();
      }
    }

    function openSpecificFile(fileName) {
      if (!currentProjectData || !currentProjectData.files) return;

      const file = findFileByName(currentProjectData.files, fileName);
      if (!file) {
        showError(`Arquivo "${fileName}" n√£o encontrado.`);
        return;
      }

      if (isUploadedFile(file)) {
        showMediaFile(file, fileName);
      } else {
        const content = joinChunks(file.chunks) || file.content || '';
        const fileType = file.language || fileName.split('.').pop() || 'text';
        showTextFile(content, fileName, fileType);
      }
    }

    function renderProject(projectData) {
      if (!projectData || !projectData.files) {
        showError('Projeto sem arquivos ou dados inv√°lidos.');
        return;
      }

      currentProjectData = projectData;

      const mainFile = findMainFile(projectData.files);
      if (mainFile) {
        // Se tem index.html ou arquivo HTML principal, abre automaticamente
        openSpecificFile(mainFile.originalName || mainFile.name);
      } else {
        // Se n√£o tem arquivo principal, mostra lista de arquivos
        showFileList();
      }

      // Atualiza t√≠tulo da p√°gina
      document.title = projectData.name || 'Visualiza√ß√£o do Projeto';
    }

    // FUN√á√ÉO PARA BUSCAR PROJETO POR SUBDOM√çNIO
    async function getProjectBySubdomain(subdomain) {
      try {
        const domainRef = db.ref('domains/' + subdomain);
        const snapshot = await domainRef.once('value');
        const domainData = snapshot.val();

        if (!domainData) {
          return null;
        }

        return domainData.projectId;
      } catch (error) {
        console.error('Erro ao buscar subdom√≠nio:', error);
        return null;
      }
    }

    // FUN√á√ÉO PARA PROCESSAR PAR√ÇMETROS DA URL
    function parseUrlParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const subdomain = urlParams.get('l');
      const projectId = urlParams.get('projectId');

      let cleanProjectId = null;
      let fileName = null;

      if (subdomain) {
        // Exemplo: ?l=meusite/arquivo.html
        if (subdomain.includes('/')) {
          const parts = subdomain.split('/');
          cleanProjectId = parts[0];
          fileName = parts.slice(1).join('/'); // Pega todo o resto como nome do arquivo
        } else {
          cleanProjectId = subdomain;
        }
        return { type: 'subdomain', projectId: cleanProjectId, fileName };
      } 
      else if (projectId) {
        // Exemplo: ?projectId=ABC123/arquivo.html
        if (projectId.includes('/')) {
          const parts = projectId.split('/');
          cleanProjectId = parts[0];
          fileName = parts.slice(1).join('/');
        } else {
          cleanProjectId = projectId;
        }
        return { type: 'projectId', projectId: cleanProjectId, fileName };
      }

      return null;
    }

    async function loadProject() {
      const params = parseUrlParameters();

      if (!params) {
        showError('Nenhum projeto especificado na URL.');
        return;
      }

      try {
        const user = await new Promise((resolve) => {
          const unsubscribe = auth.onAuthStateChanged(user => {
            unsubscribe();
            resolve(user);
          });
        });

        if (!user) {
          showError('Usu√°rio n√£o autenticado. Redirecionando...');
          setTimeout(() => window.location.href = 'auth.html', 2000);
          return;
        }

        let finalProjectId = params.projectId;

        // Se for subdom√≠nio, busca o projectId real
        if (params.type === 'subdomain') {
          finalProjectId = await getProjectBySubdomain(params.projectId);
          if (!finalProjectId) {
            showError('Subdom√≠nio n√£o encontrado.');
            return;
          }
          currentSubdomain = params.projectId;
        }

        currentProjectId = finalProjectId;

        // Busca projeto
        let projectRef = db.ref('projects/' + user.uid + '/' + finalProjectId);
        let snapshot = await projectRef.once('value');
        let projectData = snapshot.val();

        if (!projectData) {
          projectRef = db.ref('projects/' + finalProjectId);
          snapshot = await projectRef.once('value');
          projectData = snapshot.val();
        }

        if (!projectData) {
          showError('Projeto n√£o encontrado.');
          return;
        }

        currentProjectData = projectData;

        // Se tem arquivo espec√≠fico na URL
        if (params.fileName) {
          openSpecificFile(params.fileName);
        } else {
          // Mostra projeto completo (index.html ou lista)
          renderProject(projectData);
        }

      } catch (error) {
        console.error('Erro ao carregar projeto:', error);
        showError('Erro ao carregar projeto: ' + error.message);
      }
    }

    closeFileBtn.addEventListener('click', function() {
      fileViewer.style.display = 'none';
      fileContent.innerHTML = '';
      showProject(); // Volta para o projeto principal
    });

    document.addEventListener('DOMContentLoaded', function() {
      loadProject();
    });

    // Fun√ß√µes globais para acesso externo
    window.showFileList = showFileList;
    window.showProject = showProject;
    window.substituirArquivosPorURLs = substituirArquivosPorURLs;
  </script>
</body>
</html>