<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizar Projeto</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      flex-direction: column;
      z-index: 1000;
    }

    .loader {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #file-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: none;
      flex-direction: column;
      z-index: 1001;
    }

    #file-header {
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #file-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #file-content img,
    #file-content video {
      max-width: 100%;
      max-height: 100%;
    }

    #close-file {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .error {
      color: red;
      text-align: center;
      padding: 20px;
      background: #ffeaea;
      border: 1px solid #ffcccc;
      border-radius: 5px;
      margin: 20px;
    }

    /* Estilos para lista de arquivos */
    #file-list {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      padding: 20px;
      overflow-y: auto;
      z-index: 1002;
    }

    .file-item {
      padding: 15px;
      margin: 10px 0;
      background: #f5f5f5;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: background 0.3s;
    }

    .file-item:hover {
      background: #e9e9e9;
    }

    .file-name {
      font-weight: bold;
      color: #333;
    }

    .file-type {
      color: #666;
      font-size: 12px;
      margin-left: 10px;
    }

    .file-icon {
      margin-right: 10px;
      font-size: 16px;
    }

    .back-button {
      background: #4361ee;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .url-badge {
      background: #4caf50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 10px;
    }

    .project-info {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #3498db;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader"></div>
    <div>Carregando projeto...</div>
  </div>

  <div id="file-list">
    <button class="back-button" onclick="showProject()">‚Üê Voltar ao Projeto</button>
    <div id="project-info" class="project-info"></div>
    <h2>Arquivos do Projeto</h2>
    <div id="file-list-content"></div>
  </div>

  <div id="file-viewer">
    <div id="file-header">
      <span id="file-title">Visualizando Arquivo</span>
      <button id="close-file">Fechar</button>
    </div>
    <div id="file-content"></div>
  </div>

  <iframe id="preview-frame" style="display: none;"></iframe>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDon4WbCbe4kCkUq-OdLBRhzhMaUObbAfo",
      authDomain: "html-15e80.firebaseapp.com",
      databaseURL: "https://html-15e80-default-rtdb.firebaseio.com",
      projectId: "html-15e80",
      storageBucket: "html-15e80.appspot.com",
      messagingSenderId: "1068148640439",
      appId: "1:1068148640439:web:1ac651348e624f6be41b32",
      measurementId: "G-7E1VWN07GM"
    };

    // Inicializa Firebase
    let app;
    try {
      app = firebase.initializeApp(firebaseConfig);
      console.log('‚úÖ Firebase inicializado com sucesso');
    } catch (error) {
      console.log('‚ö†Ô∏è Firebase j√° inicializado, usando inst√¢ncia existente');
      app = firebase.app();
    }

    const db = firebase.database();

    const loadingEl = document.getElementById('loading');
    const previewFrame = document.getElementById('preview-frame');
    const fileViewer = document.getElementById('file-viewer');
    const fileContent = document.getElementById('file-content');
    const fileTitle = document.getElementById('file-title');
    const closeFileBtn = document.getElementById('close-file');
    const fileList = document.getElementById('file-list');
    const fileListContent = document.getElementById('file-list-content');
    const projectInfo = document.getElementById('project-info');

    let currentProjectData = null;
    let currentSubdomain = null;
    let currentProjectId = null;

    // FUN√á√ÉO SIMPLIFICADA DE SUBSTITUI√á√ÉO
    function substituirArquivosPorURLs(htmlContent, projectFiles) {
      if (!projectFiles || !htmlContent) {
        return htmlContent;
      }

      let novoHTML = htmlContent;

      // Fun√ß√£o auxiliar para encontrar arquivo
      function encontrarArquivo(nomeArquivo) {
        if (!projectFiles) return null;

        const nomeLimpo = nomeArquivo.split('/').pop().split('?')[0];

        for (const fileKey in projectFiles) {
          const file = projectFiles[fileKey];
          if (file.originalName?.toLowerCase() === nomeLimpo.toLowerCase() || 
              file.name?.toLowerCase() === nomeLimpo.toLowerCase()) {
            return file;
          }
        }
        return null;
      }

      // Substitui src
      const srcRegex = /src=["']([^"']+)["']/g;
      novoHTML = novoHTML.replace(srcRegex, (match, src) => {
        if (src.startsWith('http') || src.startsWith('data:') || src.startsWith('//')) {
          return match;
        }

        const arquivo = encontrarArquivo(src);
        if (arquivo && (arquivo.directUrl || arquivo.url)) {
          const novaUrl = arquivo.directUrl || arquivo.url;
          return `src="${novaUrl}"`;
        }
        return match;
      });

      // Substitui href para arquivos de m√≠dia
      const hrefRegex = /href=["']([^"']+)["']/g;
      novoHTML = novoHTML.replace(hrefRegex, (match, href) => {
        if (href.startsWith('http') || href.startsWith('#') || href.startsWith('mailto:')) {
          return match;
        }

        const extensoesMidia = ['.mp3', '.mp4', '.jpg', '.jpeg', '.png', '.gif', '.pdf'];
        const temExtensaoMidia = extensoesMidia.some(ext => href.toLowerCase().endsWith(ext));

        if (temExtensaoMidia) {
          const arquivo = encontrarArquivo(href);
          if (arquivo && (arquivo.directUrl || arquivo.url)) {
            const novaUrl = arquivo.directUrl || arquivo.url;
            return `href="${novaUrl}"`;
          }
        }
        return match;
      });

      return novoHTML;
    }

    // FUN√á√ÉO PARA MOSTRAR ERRO
    function showError(message) {
      loadingEl.innerHTML = `
        <div class="error">
          <h3>Erro ao carregar projeto</h3>
          <p>${message}</p>
          <button onclick="window.location.reload()" style="margin-top: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Tentar Novamente
          </button>
        </div>
      `;
    }

    // FUN√á√ÉO PARA ENCONTRAR ARQUIVO
    function findFileByName(files, fileName) {
      if (!files) return null;

      const fileNameLower = fileName.toLowerCase();

      // Procura pelo nome original
      for (const fileKey in files) {
        const file = files[fileKey];
        if (file.originalName && file.originalName.toLowerCase() === fileNameLower) {
          return file;
        }
      }

      // Procura pelo nome
      for (const fileKey in files) {
        const file = files[fileKey];
        if (file.name && file.name.toLowerCase() === fileNameLower) {
          return file;
        }
      }

      return null;
    }

    // FUN√á√ÉO PARA ENCONTRAR ARQUIVO PRINCIPAL
    function findMainFile(files) {
      if (!files) return null;

      const fileList = Object.values(files);

      // Procura por index.html
      let mainFile = fileList.find(f => 
        (f.originalName && f.originalName.toLowerCase() === 'index.html') || 
        (f.name && f.name.toLowerCase() === 'index.html')
      );

      // Se n√£o encontrou, procura qualquer HTML
      if (!mainFile) {
        mainFile = fileList.find(f => 
          (f.originalName && f.originalName.toLowerCase().endsWith('.html')) ||
          (f.name && f.name.toLowerCase().endsWith('.html'))
        );
      }

      return mainFile;
    }

    // VERIFICA SE √â ARQUIVO UPLOADED
    function isUploadedFile(file) {
      return file && (file.directUrl || file.url);
    }

    // ICONE DO ARQUIVO
    function getFileIcon(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      const icons = {
        'html': 'üåê',
        'css': 'üé®', 
        'js': '‚ö°',
        'json': 'üìã',
        'txt': 'üìÑ',
        'jpg': 'üñºÔ∏è',
        'jpeg': 'üñºÔ∏è',
        'png': 'üñºÔ∏è',
        'gif': 'üñºÔ∏è',
        'svg': 'üñºÔ∏è',
        'mp4': 'üé•',
        'avi': 'üé•',
        'mov': 'üé•',
        'mp3': 'üéµ',
        'wav': 'üéµ',
        'pdf': 'üìï'
      };
      return icons[extension] || 'üìÑ';
    }

    // MOSTRAR ARQUIVO DE M√çDIA
    function showMediaFile(file, fileName) {
      const url = file.directUrl || file.url;
      const extension = fileName.split('.').pop().toLowerCase();

      fileTitle.textContent = fileName || file.originalName || 'Arquivo';

      if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) {
        fileContent.innerHTML = `<img src="${url}" alt="${fileName}" style="max-width: 100%; max-height: 100%;">`;
      } else if (['mp4', 'avi', 'mov', 'webm'].includes(extension)) {
        fileContent.innerHTML = `
          <video controls autoplay style="max-width: 100%; max-height: 100%;">
            <source src="${url}" type="video/mp4">
            Seu navegador n√£o suporta v√≠deo.
          </video>
        `;
      } else if (['mp3', 'wav', 'ogg'].includes(extension)) {
        fileContent.innerHTML = `
          <audio controls autoplay>
            <source src="${url}" type="audio/mp3">
            Seu navegador n√£o suporta √°udio.
          </audio>
        `;
      } else if (extension === 'pdf') {
        fileContent.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      } else {
        fileContent.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
      }

      fileViewer.style.display = 'flex';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileList.style.display = 'none';
    }

    // MOSTRAR ARQUIVO DE TEXTO/HTML
    function showTextFile(content, fileName, type = 'html') {
      if (type === 'html') {
        // Aplica substitui√ß√£o autom√°tica
        const htmlComSubstituicao = substituirArquivosPorURLs(content, currentProjectData.files);
        previewFrame.srcdoc = htmlComSubstituicao;
        previewFrame.style.display = 'block';
        loadingEl.style.display = 'none';
        fileViewer.style.display = 'none';
        fileList.style.display = 'none';
        document.title = fileName || 'Projeto';
      } else {
        fileTitle.textContent = fileName;
        fileContent.innerHTML = `<pre style="font-family: 'Courier New', monospace; padding: 20px; overflow: auto; margin: 0;">${escapeHtml(content)}</pre>`;
        fileViewer.style.display = 'flex';
        loadingEl.style.display = 'none';
        previewFrame.style.display = 'none';
        fileList.style.display = 'none';
      }
    }

    // ESCAPAR HTML
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // MOSTRAR LISTA DE ARQUIVOS
    function showFileList() {
      if (!currentProjectData || !currentProjectData.files) {
        showError('Nenhum arquivo encontrado no projeto.');
        return;
      }

      fileListContent.innerHTML = '';
      const files = currentProjectData.files;

      // Info do projeto
      projectInfo.innerHTML = `
        <h3>${currentProjectData.name || 'Projeto Sem Nome'}</h3>
        <p>${Object.keys(files).length} arquivo(s) encontrado(s)</p>
      `;

      for (const fileKey in files) {
        const file = files[fileKey];
        const fileName = file.originalName || file.name || fileKey;
        const fileType = file.language || fileName.split('.').pop() || 'arquivo';
        const fileIcon = getFileIcon(fileName);
        const isUrlFile = isUploadedFile(file);

        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.onclick = () => openSpecificFile(fileName);

        fileItem.innerHTML = `
          <div>
            <span class="file-icon">${fileIcon}</span>
            <span class="file-name">${fileName}</span>
            ${isUrlFile ? '<span class="url-badge">URL</span>' : ''}
            <div class="file-type">${fileType}</div>
          </div>
        `;

        fileListContent.appendChild(fileItem);
      }

      fileList.style.display = 'block';
      loadingEl.style.display = 'none';
      previewFrame.style.display = 'none';
      fileViewer.style.display = 'none';
    }

    // MOSTRAR PROJETO
    function showProject() {
      if (!currentProjectData) return;

      const mainFile = findMainFile(currentProjectData.files);
      if (mainFile) {
        openSpecificFile(mainFile.originalName || mainFile.name);
      } else {
        showFileList();
      }
    }

    // ABRIR ARQUIVO ESPEC√çFICO
    function openSpecificFile(fileName) {
      if (!currentProjectData || !currentProjectData.files) return;

      const file = findFileByName(currentProjectData.files, fileName);
      if (!file) {
        showError(`Arquivo "${fileName}" n√£o encontrado.`);
        return;
      }

      if (isUploadedFile(file)) {
        showMediaFile(file, fileName);
      } else {
        const content = (file.chunks ? file.chunks.join('') : '') || file.content || '';
        const fileType = file.language || fileName.split('.').pop() || 'text';
        showTextFile(content, fileName, fileType);
      }
    }

    // RENDERIZAR PROJETO
    function renderProject(projectData) {
      if (!projectData || !projectData.files) {
        showError('Projeto sem arquivos ou dados inv√°lidos.');
        return;
      }

      currentProjectData = projectData;
      document.title = projectData.name || 'Visualiza√ß√£o do Projeto';

      const mainFile = findMainFile(projectData.files);
      if (mainFile) {
        openSpecificFile(mainFile.originalName || mainFile.name);
      } else {
        showFileList();
      }
    }

    // BUSCAR PROJETO POR SUBDOM√çNIO
    async function getProjectBySubdomain(subdomain) {
      try {
        const dominioLower = subdomain.toLowerCase();
        const domainRef = db.ref('domains/' + dominioLower);
        const snapshot = await domainRef.once('value');
        const domainData = snapshot.val();

        if (!domainData) {
          return null;
        }

        return domainData.projectId;
      } catch (error) {
        console.error('Erro ao buscar subdom√≠nio:', error);
        return null;
      }
    }

    // ANALISAR PAR√ÇMETROS DA URL
    function parseUrlParameters() {
      const path = window.location.pathname;
      const urlParams = new URLSearchParams(window.location.search);
      const subdomain = urlParams.get('l');
      const projectId = urlParams.get('projectId');

      console.log('üìç Analisando URL:', { path, subdomain, projectId });

      // Verifica par√¢metros na query string
      if (subdomain) {
        let fileName = null;
        if (subdomain.includes('/')) {
          const parts = subdomain.split('/');
          const cleanSubdomain = parts[0];
          fileName = parts.slice(1).join('/');
          return { type: 'subdomain', projectId: cleanSubdomain, fileName };
        } else {
          return { type: 'subdomain', projectId: subdomain, fileName: null };
        }
      } else if (projectId) {
        let fileName = null;
        if (projectId.includes('/')) {
          const parts = projectId.split('/');
          const cleanProjectId = parts[0];
          fileName = parts.slice(1).join('/');
          return { type: 'projectId', projectId: cleanProjectId, fileName };
        } else {
          return { type: 'projectId', projectId: projectId, fileName: null };
        }
      }

      // Verifica path /view.html/...
      if (path.includes('/view.html/')) {
        const parts = path.split('/view.html/');
        if (parts.length > 1) {
          const restante = parts[1];
          const subParts = restante.split('/');

          if (subParts.length >= 1) {
            const dominioOuProjectId = subParts[0];
            const fileName = subParts.length > 1 ? subParts.slice(1).join('/') : null;

            if (dominioOuProjectId.startsWith('-')) {
              return { type: 'projectId', projectId: dominioOuProjectId, fileName };
            } else {
              return { type: 'subdomain', projectId: dominioOuProjectId, fileName };
            }
          }
        }
      }

      return null;
    }

    // CARREGAR PROJETO - VERS√ÉO SIMPLIFICADA
    async function loadProject() {
      console.log('üöÄ Iniciando carregamento do projeto...');

      const params = parseUrlParameters();
      console.log('üìã Par√¢metros encontrados:', params);

      if (!params) {
        showError('Nenhum projeto especificado na URL.<br>Use: /view.html/dominio ou /view.html?l=dominio');
        return;
      }

      try {
        let finalProjectId = params.projectId;

        // Se for subdom√≠nio, busca o projectId real
        if (params.type === 'subdomain') {
          console.log('üîç Buscando subdom√≠nio:', params.projectId);
          const dominioNormalizado = params.projectId.toLowerCase();
          finalProjectId = await getProjectBySubdomain(dominioNormalizado);
          
          if (!finalProjectId) {
            showError(`Subdom√≠nio "${params.projectId}" n√£o encontrado.`);
            return;
          }
          
          currentSubdomain = dominioNormalizado;
          console.log('‚úÖ Subdom√≠nio encontrado, projectId:', finalProjectId);
        } else {
          currentProjectId = params.projectId;
        }

        currentProjectId = finalProjectId;

        // Tenta diferentes caminhos no Firebase
        const pathsToTry = [
          `projects/${finalProjectId}`,
          `public-projects/${finalProjectId}`,
          `projects/public/${finalProjectId}`
        ];

        let projectData = null;
        
        for (const path of pathsToTry) {
          console.log(`üîç Tentando buscar em: ${path}`);
          const projectRef = db.ref(path);
          const snapshot = await projectRef.once('value');
          projectData = snapshot.val();
          
          if (projectData) {
            console.log(`‚úÖ Projeto encontrado em: ${path}`);
            break;
          }
        }

        if (!projectData) {
          showError(`Projeto "${finalProjectId}" n√£o encontrado no banco de dados.`);
          return;
        }

        currentProjectData = projectData;

        // Esconde loading
        loadingEl.style.display = 'none';

        // Abre arquivo espec√≠fico ou projeto completo
        if (params.fileName) {
          openSpecificFile(params.fileName);
        } else {
          renderProject(projectData);
        }

      } catch (error) {
        console.error('‚ùå Erro ao carregar projeto:', error);
        showError(`Erro: ${error.message}`);
      }
    }

    // EVENT LISTENERS
    closeFileBtn.addEventListener('click', function() {
      fileViewer.style.display = 'none';
      fileContent.innerHTML = '';
      showProject();
    });

    // INICIAR CARREGAMENTO
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM carregado, iniciando projeto...');
      setTimeout(() => {
        loadProject();
      }, 100);
    });

    // FUN√á√ïES GLOBAIS
    window.showFileList = showFileList;
    window.showProject = showProject;
    window.abrirArquivoNoVisualizador = openSpecificFile;
    window.openSpecificFile = openSpecificFile;
  </script>
</body>
</html>